<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>libvisual: lv_beat.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">libvisual
   &#160;<span id="projectnumber">0.5.0</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">lv_beat.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="lv__beat_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* Libvisual - The audio visualisation framework.</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> * Copyright (C) 2004, 2005, 2006 Dennis Smit &lt;ds@nerds-incorporated.org&gt;</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * Authors: Scott Sibley &lt;scott@starlon.net&gt;</span>
<a name="l00006"></a>00006 <span class="comment"> * Adapted from Winamp&#39;s AVS plugin. See below.</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * $Id$</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00011"></a>00011 <span class="comment"> * it under the terms of the GNU Lesser General Public License as</span>
<a name="l00012"></a>00012 <span class="comment"> * published by the Free Software Foundation; either version 2.1</span>
<a name="l00013"></a>00013 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00014"></a>00014 <span class="comment"> *</span>
<a name="l00015"></a>00015 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00016"></a>00016 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00017"></a>00017 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00018"></a>00018 <span class="comment"> * GNU Lesser General Public License for more details.</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * You should have received a copy of the GNU Lesser General Public License</span>
<a name="l00021"></a>00021 <span class="comment"> * along with this program; if not, write to the Free Software</span>
<a name="l00022"></a>00022 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<a name="l00023"></a>00023 <span class="comment"> */</span>
<a name="l00024"></a>00024 <span class="comment">/*</span>
<a name="l00025"></a>00025 <span class="comment">  LICENSE</span>
<a name="l00026"></a>00026 <span class="comment">  -------</span>
<a name="l00027"></a>00027 <span class="comment">Copyright 2005 Nullsoft, Inc.</span>
<a name="l00028"></a>00028 <span class="comment">All rights reserved.</span>
<a name="l00029"></a>00029 <span class="comment"></span>
<a name="l00030"></a>00030 <span class="comment">Redistribution and use in source and binary forms, with or without modification,</span>
<a name="l00031"></a>00031 <span class="comment">are permitted provided that the following conditions are met:</span>
<a name="l00032"></a>00032 <span class="comment"></span>
<a name="l00033"></a>00033 <span class="comment">  * Redistributions of source code must retain the above copyright notice,</span>
<a name="l00034"></a>00034 <span class="comment">    this list of conditions and the following disclaimer.</span>
<a name="l00035"></a>00035 <span class="comment"></span>
<a name="l00036"></a>00036 <span class="comment">  * Redistributions in binary form must reproduce the above copyright notice,</span>
<a name="l00037"></a>00037 <span class="comment">    this list of conditions and the following disclaimer in the documentation</span>
<a name="l00038"></a>00038 <span class="comment">    and/or other materials provided with the distribution.</span>
<a name="l00039"></a>00039 <span class="comment"></span>
<a name="l00040"></a>00040 <span class="comment">  * Neither the name of Nullsoft nor the names of its contributors may be used to</span>
<a name="l00041"></a>00041 <span class="comment">    endorse or promote products derived from this software without specific prior written permission.</span>
<a name="l00042"></a>00042 <span class="comment"></span>
<a name="l00043"></a>00043 <span class="comment">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR</span>
<a name="l00044"></a>00044 <span class="comment">IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND</span>
<a name="l00045"></a>00045 <span class="comment">FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR</span>
<a name="l00046"></a>00046 <span class="comment">CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<a name="l00047"></a>00047 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<a name="l00048"></a>00048 <span class="comment">DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER</span>
<a name="l00049"></a>00049 <span class="comment">IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT</span>
<a name="l00050"></a>00050 <span class="comment">OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00051"></a>00051 <span class="comment"></span>
<a name="l00052"></a>00052 <span class="comment">*/</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;config.h&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="lv__beat_8h.html">lv_beat.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="lv__common_8h.html">lv_common.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="lv__time_8h.html">lv_time.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="lv__util_8h.html">lv_util.h</a>&quot;</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="keywordtype">int</span> <a class="code" href="lv__beat_8c.html#ad85c9e2bccf15de1ca00bc1ae721dbfa">beat_song_changed</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat);
<a name="l00066"></a>00066 <span class="keywordtype">void</span> <a class="code" href="lv__beat_8c.html#ac3c27ceae000a424a6200b793dfb3f78">beat_insert_hist_step</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat, <a class="code" href="struct__VisBeatType.html">VisBeatType</a> *t, clock_t TC, <span class="keywordtype">int</span> type, <span class="keywordtype">int</span> i);
<a name="l00067"></a>00067 <span class="keywordtype">void</span> <a class="code" href="lv__beat_8c.html#a329ee39f88e8a43f970abc9157d088b9">beat_double_beat</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat);
<a name="l00068"></a>00068 <span class="keywordtype">void</span> <a class="code" href="lv__beat_8c.html#a909c7620df5bc4053636c33a54a266f1">beat_half_beat</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat);
<a name="l00069"></a>00069 <span class="keywordtype">int</span> <a class="code" href="lv__beat_8c.html#a4ea7d4d1aaad543af0816d54ba712fd8">beat_TC_hist_step</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat, <a class="code" href="struct__VisBeatType.html">VisBeatType</a> *t, <span class="keywordtype">int</span> *_hdPos, clock_t TC, <span class="keywordtype">int</span> type);
<a name="l00070"></a>00070 <span class="keywordtype">int</span> <a class="code" href="lv__beat_8c.html#a4c5e0811cce5e73f38342a26d0e1594e">beat_ready_to_learn</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat);
<a name="l00071"></a>00071 <span class="keywordtype">int</span> <a class="code" href="lv__beat_8c.html#a640ff532a811c57ce81fc3cfaab120a4">beat_ready_to_guess</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat);
<a name="l00072"></a>00072 <span class="keywordtype">void</span> <a class="code" href="lv__beat_8c.html#ad52a77a0a59baebfd9b4b6199c16fa38">beat_new_bpm</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat, <span class="keywordtype">int</span> thisBpm);
<a name="l00073"></a>00073 <span class="keywordtype">int</span> <a class="code" href="lv__beat_8c.html#a31444d117345130ae44cf58cf75718c7">beat_get_bpm</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat);
<a name="l00074"></a>00074 <span class="keywordtype">void</span> <a class="code" href="lv__beat_8c.html#a7099b46b01a082c806fa64cc9ca99dcf">beat_calc_bpm</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat);
<a name="l00075"></a>00075 <span class="keywordtype">void</span> <a class="code" href="lv__beat_8c.html#a7abe8c605152e709d8099878908fe39a">beat_slider_step</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat, <span class="keywordtype">int</span> Ctl, <span class="keywordtype">int</span> *slide);
<a name="l00076"></a>00076 <span class="keywordtype">int</span> <a class="code" href="lv__beat_8c.html#a3e642eff461b9872a59d7c3b476e0044">beat_get_time_offset_since_start</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat, clock_t TC);
<a name="l00077"></a>00077 
<a name="l00078"></a><a class="code" href="lv__beat_8c.html#ac6afabdc09a49a433ee19d8a9486056d">00078</a> <span class="preprocessor">#define min(a, b) a &lt; b ? a : b;</span>
<a name="l00079"></a><a class="code" href="lv__beat_8c.html#affe776513b24d84b39af8ab0930fef7f">00079</a> <span class="preprocessor"></span><span class="preprocessor">#define max(a, b) a &gt; b ? a : b;</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>
<a name="l00081"></a>00081 <span class="keyword">static</span> <span class="keywordtype">int</span> beat_dtor(<a class="code" href="struct__VisObject.html" title="The VisObject structure contains all the VisObject housekeeping data like refcounting and a pointer t...">VisObject</a> *obj)
<a name="l00082"></a>00082 {
<a name="l00083"></a>00083     <a class="code" href="struct__VisBeat.html">VisBeat</a> *beat = <a class="code" href="group__VisBeat.html#gac999f89abfbe9267d2485f54f1536ecd">VISUAL_BEAT</a>(obj);
<a name="l00084"></a>00084 
<a name="l00085"></a>00085     <span class="keywordflow">if</span>(beat-&gt;<a class="code" href="struct__VisBeat.html#acbc1e2ebceeb1eae0e4ba1722a9d382c">txt</a> != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00086"></a>00086         <a class="code" href="group__VisMem.html#gad28e0c8516ddcb841d40b77259c78ed4" title="Frees allocated memory.">visual_mem_free</a>(beat-&gt;<a class="code" href="struct__VisBeat.html#acbc1e2ebceeb1eae0e4ba1722a9d382c">txt</a>);
<a name="l00087"></a>00087 
<a name="l00088"></a>00088     beat-&gt;<a class="code" href="struct__VisBeat.html#acbc1e2ebceeb1eae0e4ba1722a9d382c">txt</a> = <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090     <span class="keywordflow">if</span>(beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a> != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00091"></a>00091         <a class="code" href="group__VisMem.html#gad28e0c8516ddcb841d40b77259c78ed4" title="Frees allocated memory.">visual_mem_free</a>(beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093     beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a> = <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00094"></a>00094 
<a name="l00095"></a>00095     <span class="keywordflow">if</span>(beat-&gt;<a class="code" href="struct__VisBeat.html#a46432ddabfe1b9d116a5facb83265fc9">smoother</a> != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00096"></a>00096         <a class="code" href="group__VisMem.html#gad28e0c8516ddcb841d40b77259c78ed4" title="Frees allocated memory.">visual_mem_free</a>(beat-&gt;<a class="code" href="struct__VisBeat.html#a46432ddabfe1b9d116a5facb83265fc9">smoother</a>);
<a name="l00097"></a>00097 
<a name="l00098"></a>00098     beat-&gt;<a class="code" href="struct__VisBeat.html#a46432ddabfe1b9d116a5facb83265fc9">smoother</a> = <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100     <span class="keywordflow">if</span>(beat-&gt;<a class="code" href="struct__VisBeat.html#a67d9ffc8276f55527d9dc2d36e4f6e1e">half_discriminated</a> != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00101"></a>00101         <a class="code" href="group__VisMem.html#gad28e0c8516ddcb841d40b77259c78ed4" title="Frees allocated memory.">visual_mem_free</a>(beat-&gt;<a class="code" href="struct__VisBeat.html#a67d9ffc8276f55527d9dc2d36e4f6e1e">half_discriminated</a>);
<a name="l00102"></a>00102 
<a name="l00103"></a>00103     beat-&gt;<a class="code" href="struct__VisBeat.html#a67d9ffc8276f55527d9dc2d36e4f6e1e">half_discriminated</a> = <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00104"></a>00104 
<a name="l00105"></a>00105     <span class="keywordflow">if</span>(beat-&gt;<a class="code" href="struct__VisBeat.html#a5778af15a404badb08a9c708b146463e">half_discriminated2</a> != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00106"></a>00106         <a class="code" href="group__VisMem.html#gad28e0c8516ddcb841d40b77259c78ed4" title="Frees allocated memory.">visual_mem_free</a>(beat-&gt;<a class="code" href="struct__VisBeat.html#a5778af15a404badb08a9c708b146463e">half_discriminated2</a>);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108     beat-&gt;<a class="code" href="struct__VisBeat.html#a5778af15a404badb08a9c708b146463e">half_discriminated2</a> = <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00109"></a>00109 
<a name="l00110"></a>00110     <span class="keywordflow">if</span>(beat-&gt;<a class="code" href="struct__VisBeat.html#aa5d39195cbc9a3fb1ac1564980a1e84c">adv</a> != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00111"></a>00111         <a class="code" href="group__VisObject.html#gafd90dd70679ecae99a4a55cd605556b6" title="Decreases the reference counter for a VisObject.">visual_object_unref</a>(<a class="code" href="group__VisObject.html#gaf188438cc2a544151f50b4fb4db53e86">VISUAL_OBJECT</a>(beat-&gt;<a class="code" href="struct__VisBeat.html#aa5d39195cbc9a3fb1ac1564980a1e84c">adv</a>));
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     beat-&gt;<a class="code" href="struct__VisBeat.html#aa5d39195cbc9a3fb1ac1564980a1e84c">adv</a> = <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     <span class="keywordflow">return</span> <a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00116"></a>00116 }
<a name="l00117"></a>00117 
<a name="l00118"></a><a class="code" href="group__VisBeat.html#gadbcef0392e78f128c49533360b358895">00118</a> <a class="code" href="struct__VisBeat.html">VisBeat</a> *<a class="code" href="group__VisBeat.html#gadbcef0392e78f128c49533360b358895" title="Create a new VisBeat.">visual_beat_new</a>()
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120     <a class="code" href="struct__VisBeat.html">VisBeat</a> *beat = <a class="code" href="group__VisMem.html#gacc3a119d795b22d441e0c9189ccc3eee" title="Convenient macro to request n_structs structures of type struct_type initialized to 0...">visual_mem_new0</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a>, 1);
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <a class="code" href="group__VisObject.html#gafa30ee9f9c0047a0b8e50cae19394571" title="Initializes a VisObject for usage.">visual_object_initialize</a> (<a class="code" href="group__VisObject.html#gaf188438cc2a544151f50b4fb4db53e86">VISUAL_OBJECT</a>(beat), <a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, beat_dtor);
<a name="l00123"></a>00123 
<a name="l00124"></a>00124     <a class="code" href="group__VisBeat.html#ga7c438634885deaf9c47b4f80768b89eb" title="Initialize a VisBeat.">visual_beat_init</a>(beat);
<a name="l00125"></a>00125 
<a name="l00126"></a>00126     <span class="keywordflow">return</span> beat;
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 
<a name="l00129"></a><a class="code" href="group__VisBeat.html#ga7c438634885deaf9c47b4f80768b89eb">00129</a> <span class="keywordtype">int</span> <a class="code" href="group__VisBeat.html#ga7c438634885deaf9c47b4f80768b89eb" title="Initialize a VisBeat.">visual_beat_init</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat)
<a name="l00130"></a>00130 {
<a name="l00131"></a>00131     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55bad01bdd685848e5513c06a0f0cb1faf27" title="The VisBeat is NULL.">VISUAL_ERROR_BEAT_NULL</a>);
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     beat-&gt;<a class="code" href="struct__VisBeat.html#aa134a749e892cef51589db39f305941c">TCUsed</a>=0;
<a name="l00134"></a>00134     beat-&gt;<a class="code" href="struct__VisBeat.html#a18e40f120fa7eff1ba423ca32c1ba91d">topConfidenceCount</a>=0;
<a name="l00135"></a>00135     beat-&gt;<a class="code" href="struct__VisBeat.html#a68eee14f066e94e38a01776a8c261a78">forceNewBeat</a>=0;
<a name="l00136"></a>00136     beat-&gt;<a class="code" href="struct__VisBeat.html#a22e288cdb9a4aacaf1b97ca11b13a0e1">hdPos</a>=0;
<a name="l00137"></a>00137     beat-&gt;<a class="code" href="struct__VisBeat.html#a839355cd551e943492aa2c7ac1b1fe77">hdPos2</a>=0;
<a name="l00138"></a>00138     beat-&gt;<a class="code" href="struct__VisBeat.html#a0cdc87440af5fea3c21fdc42f1fb48d5">inSlide</a>=0;
<a name="l00139"></a>00139     beat-&gt;<a class="code" href="struct__VisBeat.html#af9939e4a88673e46246b3ba304f334ad">outSlide</a>=0;
<a name="l00140"></a>00140     beat-&gt;<a class="code" href="struct__VisBeat.html#a866f7278f98b3faea983378a449e1aeb">oldDisplayBpm</a>=-1;
<a name="l00141"></a>00141     beat-&gt;<a class="code" href="struct__VisBeat.html#a30920acca8d7bc061f0e4acdb112968e">oldDisplayConfidence</a>=-1;
<a name="l00142"></a>00142     beat-&gt;<a class="code" href="struct__VisBeat.html#a0d9fea31d74aa29c1d77c31b6db56dfa">oldInSlide</a>=0;
<a name="l00143"></a>00143     beat-&gt;<a class="code" href="struct__VisBeat.html#a026e3cdfdbfd9314e552efd386b29aca">oldOutSlide</a>=0;
<a name="l00144"></a>00144     beat-&gt;<a class="code" href="struct__VisBeat.html#a23d65d540f200b468799577b309d4603">outInc</a> = 1;
<a name="l00145"></a>00145     beat-&gt;<a class="code" href="struct__VisBeat.html#a501f230e14669672ce22996a49b15362">inInc</a> = 1;
<a name="l00146"></a>00146     beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a> = 0;
<a name="l00147"></a>00147     beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a> = 0;
<a name="l00148"></a>00148     beat-&gt;<a class="code" href="struct__VisBeat.html#aa971af34b09033b6d1bfe70541b7c533">avg2</a> = 0;
<a name="l00149"></a>00149     beat-&gt;<a class="code" href="struct__VisBeat.html#a2421bb95991710257ba3edf4070698d0">smPtr</a> = 0;
<a name="l00150"></a>00150     beat-&gt;<a class="code" href="struct__VisBeat.html#ad917cb1f0b7bb2893cab50db4470fc72">smSize</a> = 8;
<a name="l00151"></a>00151     beat-&gt;<a class="code" href="struct__VisBeat.html#a63e1ffa3a86be9480f31223fc383b3c2">offIMax</a> = 8;
<a name="l00152"></a>00152     beat-&gt;<a class="code" href="struct__VisBeat.html#a3da842c8e386925cb3b779aad495f398">insertionCount</a> = 0;
<a name="l00153"></a>00153     beat-&gt;<a class="code" href="struct__VisBeat.html#aad7a242bb1dbcf5858cc495a247c0149">predictionLastTC</a> = 0;
<a name="l00154"></a>00154     beat-&gt;<a class="code" href="struct__VisBeat.html#af7e674f80c3f59a2d00e749acc1ba7b5">confidence</a> = 0;
<a name="l00155"></a>00155     beat-&gt;<a class="code" href="struct__VisBeat.html#a4f46fb092b171f4261f52f34f0a94a91">confidence1</a> = 0;
<a name="l00156"></a>00156     beat-&gt;<a class="code" href="struct__VisBeat.html#a589ca3cf9cccfca6146edbeed0ea822f">confidence2</a> = 0;
<a name="l00157"></a>00157     beat-&gt;<a class="code" href="struct__VisBeat.html#abf678935d2638bf5881650d846d14e39">halfCount</a>=0;
<a name="l00158"></a>00158     beat-&gt;<a class="code" href="struct__VisBeat.html#a28789b887916dc15129eac0a9f0b108a">doubleCount</a>=0;
<a name="l00159"></a>00159     beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a> = 8;
<a name="l00160"></a>00160     beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a>=0;
<a name="l00161"></a>00161     beat-&gt;<a class="code" href="struct__VisBeat.html#ac7cdecc4ba18df6f8fbf2d0a69369084">stickyConfidenceCount</a>=0;
<a name="l00162"></a>00162     beat-&gt;<a class="code" href="struct__VisBeat.html#a82886870bf5bc25dae5ef0b6e42c20a6">sticked</a>=0;
<a name="l00163"></a>00163     beat-&gt;<a class="code" href="struct__VisBeat.html#a0694f254081110d9ccc8db49a9fd280d">oldsticked</a>=-1;
<a name="l00164"></a>00164     beat-&gt;<a class="code" href="struct__VisBeat.html#a23a8154884634a0662e9ee50d15cd418">new_song</a> = <a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00165"></a>00165     beat-&gt;<a class="code" href="struct__VisBeat.html#a407fa89b37a9a521be1f1982a0b138d4">cfg_smartbeat</a> = <a class="code" href="lv__defines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00166"></a>00166     beat-&gt;<a class="code" href="struct__VisBeat.html#addfdedc3e8acfb84a957bec2396ef1ac">cfg_smartbeatsticky</a> = <a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00167"></a>00167     beat-&gt;<a class="code" href="struct__VisBeat.html#aa3cb47d96b9eb3883a90806e596bb06d">cfg_smartbeatresetnewsong</a> = <a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00168"></a>00168     beat-&gt;<a class="code" href="struct__VisBeat.html#a489bf8dce51a5719dc2033faab60a477">cfg_smartbeatonlysticky</a> = <a class="code" href="lv__defines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00169"></a>00169     beat-&gt;<a class="code" href="struct__VisBeat.html#a44cf259265ea344e2833cff7091c72a5">lastTC</a> = 0;
<a name="l00170"></a>00170     beat-&gt;<a class="code" href="struct__VisBeat.html#afb8a465dd3c94b10a1c84aa150dddf6b">startTC</a> = clock() / (float)CLOCKS_PER_SEC * 60000;
<a name="l00171"></a>00171     beat-&gt;<a class="code" href="struct__VisBeat.html#acbc1e2ebceeb1eae0e4ba1722a9d382c">txt</a> = <a class="code" href="group__VisMem.html#gab01866ccec5e012f7e8ca5c8abb7fc1e" title="Allocates nbytes of memory initialized to 0.">visual_mem_malloc0</a>(256);
<a name="l00172"></a>00172     beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a> = <a class="code" href="group__VisMem.html#gab01866ccec5e012f7e8ca5c8abb7fc1e" title="Allocates nbytes of memory initialized to 0.">visual_mem_malloc0</a>(beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>*<span class="keyword">sizeof</span>(<a class="code" href="struct__VisBeatType.html">VisBeatType</a>));
<a name="l00173"></a>00173     beat-&gt;<a class="code" href="struct__VisBeat.html#a46432ddabfe1b9d116a5facb83265fc9">smoother</a> = <a class="code" href="group__VisMem.html#gab01866ccec5e012f7e8ca5c8abb7fc1e" title="Allocates nbytes of memory initialized to 0.">visual_mem_malloc0</a>(beat-&gt;<a class="code" href="struct__VisBeat.html#ad917cb1f0b7bb2893cab50db4470fc72">smSize</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00174"></a>00174     beat-&gt;<a class="code" href="struct__VisBeat.html#a67d9ffc8276f55527d9dc2d36e4f6e1e">half_discriminated</a> = <a class="code" href="group__VisMem.html#gab01866ccec5e012f7e8ca5c8abb7fc1e" title="Allocates nbytes of memory initialized to 0.">visual_mem_malloc0</a>(beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>*(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)));
<a name="l00175"></a>00175     beat-&gt;<a class="code" href="struct__VisBeat.html#a5778af15a404badb08a9c708b146463e">half_discriminated2</a> = <a class="code" href="group__VisMem.html#gab01866ccec5e012f7e8ca5c8abb7fc1e" title="Allocates nbytes of memory initialized to 0.">visual_mem_malloc0</a>(beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>*(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)));
<a name="l00176"></a>00176     beat-&gt;<a class="code" href="struct__VisBeat.html#aa5d39195cbc9a3fb1ac1564980a1e84c">adv</a> = <a class="code" href="group__VisBeatAdv.html#gabc800aacdef045c740f4afbfe5b8c4d9" title="Create a VisBeat and initialize it.">visual_beat_adv_new</a>();
<a name="l00177"></a>00177 
<a name="l00178"></a>00178     <span class="keywordtype">int</span> x;
<a name="l00179"></a>00179     <span class="keywordflow">for</span> (x = 0; x &lt; 256; x ++)
<a name="l00180"></a>00180     {
<a name="l00181"></a>00181         <span class="keywordtype">double</span> a=log(x*60.0/255.0 + 1.0)/log(60.0);
<a name="l00182"></a>00182         <span class="keywordtype">int</span> t=(int)(a*255.0);
<a name="l00183"></a>00183         <span class="keywordflow">if</span> (t&lt;0)t=0;
<a name="l00184"></a>00184         <span class="keywordflow">if</span> (t&gt;255)t=255;
<a name="l00185"></a>00185         beat-&gt;<a class="code" href="struct__VisBeat.html#af1607c82f141b96a40b0fd43c8563bc3">logtab</a>[x]=(<span class="keywordtype">unsigned</span> char )t;
<a name="l00186"></a>00186     }
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     <span class="keywordflow">return</span> <a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55ba73e463399cd84c08294d95cf0b4b7cf8" title="No error.">VISUAL_OK</a>;
<a name="l00189"></a>00189 }
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 <span class="keyword">static</span> <span class="keywordtype">int</span> beat_adv_dtor(<a class="code" href="struct__VisObject.html" title="The VisObject structure contains all the VisObject housekeeping data like refcounting and a pointer t...">VisObject</a> *obj)
<a name="l00192"></a>00192 {
<a name="l00193"></a>00193     <a class="code" href="struct__VisBeatAdv.html">VisBeatAdv</a> *adv = <a class="code" href="group__VisBeat.html#ga74feb1026b51fa1985b0915af91d4b6d">VISUAL_BEAT_ADV</a>(obj);
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     <a class="code" href="group__VisTime.html#ga7496cc3ec3abfcedb82b74e9f400d7b3">visual_time_free</a> (adv-&gt;<a class="code" href="struct__VisBeatAdv.html#a270c1ea5be5877d96016f54c023070cb">lastDetect</a>);
<a name="l00196"></a>00196 
<a name="l00197"></a>00197     <span class="keywordflow">if</span>(adv-&gt;<a class="code" href="struct__VisBeatAdv.html#aa3527ed8475befcff56eb2fe9efe5fc0">beathistory</a> != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00198"></a>00198         <a class="code" href="group__VisMem.html#gad28e0c8516ddcb841d40b77259c78ed4" title="Frees allocated memory.">visual_mem_free</a>(adv-&gt;<a class="code" href="struct__VisBeatAdv.html#aa3527ed8475befcff56eb2fe9efe5fc0">beathistory</a>);
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#aa3527ed8475befcff56eb2fe9efe5fc0">beathistory</a> = <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <span class="keywordflow">return</span> <a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00203"></a>00203 }
<a name="l00204"></a>00204 
<a name="l00205"></a><a class="code" href="group__VisBeatAdv.html#gabc800aacdef045c740f4afbfe5b8c4d9">00205</a> <a class="code" href="struct__VisBeatAdv.html">VisBeatAdv</a> *<a class="code" href="group__VisBeatAdv.html#gabc800aacdef045c740f4afbfe5b8c4d9" title="Create a VisBeat and initialize it.">visual_beat_adv_new</a>()
<a name="l00206"></a>00206 {
<a name="l00207"></a>00207     <a class="code" href="struct__VisBeatAdv.html">VisBeatAdv</a> *adv = <a class="code" href="group__VisMem.html#gacc3a119d795b22d441e0c9189ccc3eee" title="Convenient macro to request n_structs structures of type struct_type initialized to 0...">visual_mem_new0</a>(<a class="code" href="struct__VisBeatAdv.html">VisBeatAdv</a>, 1);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <a class="code" href="group__VisObject.html#gafa30ee9f9c0047a0b8e50cae19394571" title="Initializes a VisObject for usage.">visual_object_initialize</a> (<a class="code" href="group__VisObject.html#gaf188438cc2a544151f50b4fb4db53e86">VISUAL_OBJECT</a>(adv), <a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, beat_adv_dtor);
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <a class="code" href="group__VisBeatAdv.html#gacb2bc052fbbd816164f69aac5fb2ee12" title="Initialize a VisBeatAdv.">visual_beat_adv_init</a>(adv);
<a name="l00212"></a>00212 
<a name="l00213"></a>00213     <span class="keywordflow">return</span> adv;
<a name="l00214"></a>00214 }
<a name="l00215"></a>00215 
<a name="l00216"></a><a class="code" href="group__VisBeatAdv.html#gacb2bc052fbbd816164f69aac5fb2ee12">00216</a> <span class="keywordtype">int</span> <a class="code" href="group__VisBeatAdv.html#gacb2bc052fbbd816164f69aac5fb2ee12" title="Initialize a VisBeatAdv.">visual_beat_adv_init</a>(<a class="code" href="struct__VisBeatAdv.html">VisBeatAdv</a> *adv)
<a name="l00217"></a>00217 {
<a name="l00218"></a>00218     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(adv != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55baf892cb36cb1bf13623285ada18d55adb" title="The VisBeatAdv is NULL.">VISUAL_ERROR_BEAT_ADV_NULL</a>);
<a name="l00219"></a>00219 
<a name="l00220"></a>00220     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#aa3527ed8475befcff56eb2fe9efe5fc0">beathistory</a> = <a class="code" href="group__VisMem.html#gab01866ccec5e012f7e8ca5c8abb7fc1e" title="Allocates nbytes of memory initialized to 0.">visual_mem_malloc0</a>(<a class="code" href="group__VisBeat.html#gae6b260c0dbd624fa4690e1818ca13e42">BEAT_ADV_MAX</a> * <span class="keyword">sizeof</span>(int32_t));
<a name="l00221"></a>00221     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#a4dcd83886e93645624e2ea6386355041">aged</a> = 0;
<a name="l00222"></a>00222     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#a766bcd954fee8fa88b0191c17c577b84">lowest</a> = 0;
<a name="l00223"></a>00223     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#a21393d1c2806162743ec28ce79555d4c">elapsed</a> = 0;
<a name="l00224"></a>00224     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#a720458d0ebe25f77ea947e85ae42724a">isquiet</a> = 0;
<a name="l00225"></a>00225     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#a13efb54bb26d27e6f5d5acdc47012ea8">prevbeat</a> = 0;
<a name="l00226"></a>00226     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#a5247c79947b4961341385323a58b1705">beatbase</a> = 0;
<a name="l00227"></a>00227     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#a4ecac3c3113b455e41132859307fe729">beatquiet</a> = 0;
<a name="l00228"></a>00228 
<a name="l00229"></a>00229     <span class="comment">// defaults</span>
<a name="l00230"></a>00230     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#a02294c3f2b6bb9d811862e0d4b640c52">cfg_sensitivity</a> = 15;
<a name="l00231"></a>00231     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#ad8a748a912146dd521c1ff67efbf270e">cfg_max_detect</a> = 200;
<a name="l00232"></a>00232     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#a1b71fcbe3d2c8a4cd5f6a85b1b775de8">cfg_thick_on_beats</a> = 0;
<a name="l00233"></a>00233 
<a name="l00234"></a>00234     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#a270c1ea5be5877d96016f54c023070cb">lastDetect</a> = <a class="code" href="group__VisTime.html#ga9da6dfef27c83b3ca99c37ca9ab8a83a">visual_time_new</a> ();
<a name="l00235"></a>00235 
<a name="l00236"></a>00236     <span class="keywordflow">return</span> <a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55ba73e463399cd84c08294d95cf0b4b7cf8" title="No error.">VISUAL_OK</a>;
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a><a class="code" href="group__VisBeat.html#gace0c68fc28f759167ca2c7b71438e49e">00239</a> <span class="keywordtype">int</span> <a class="code" href="group__VisBeat.html#gace0c68fc28f759167ca2c7b71438e49e" title="Set the configuration parameters for a VisBeat.">visual_beat_set_config</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat, <span class="keywordtype">int</span> smartbeat, <span class="keywordtype">int</span> smartbeatsticky, <span class="keywordtype">int</span> smartbeatresetnewsong, <span class="keywordtype">int</span> smartbeatonlysticky)
<a name="l00240"></a>00240 {
<a name="l00241"></a>00241     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55bad01bdd685848e5513c06a0f0cb1faf27" title="The VisBeat is NULL.">VISUAL_ERROR_BEAT_NULL</a>);
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     beat-&gt;<a class="code" href="struct__VisBeat.html#a407fa89b37a9a521be1f1982a0b138d4">cfg_smartbeat</a> = smartbeat;
<a name="l00244"></a>00244     beat-&gt;<a class="code" href="struct__VisBeat.html#addfdedc3e8acfb84a957bec2396ef1ac">cfg_smartbeatsticky</a> = smartbeatsticky;
<a name="l00245"></a>00245     beat-&gt;<a class="code" href="struct__VisBeat.html#aa3cb47d96b9eb3883a90806e596bb06d">cfg_smartbeatresetnewsong</a> = smartbeatresetnewsong;
<a name="l00246"></a>00246     beat-&gt;<a class="code" href="struct__VisBeat.html#a489bf8dce51a5719dc2033faab60a477">cfg_smartbeatonlysticky</a> = smartbeatonlysticky;
<a name="l00247"></a>00247 
<a name="l00248"></a>00248     <span class="keywordflow">return</span> <a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55ba73e463399cd84c08294d95cf0b4b7cf8" title="No error.">VISUAL_OK</a>;
<a name="l00249"></a>00249 }
<a name="l00250"></a>00250 
<a name="l00251"></a><a class="code" href="group__VisBeat.html#ga918e331144008ce8808aa9abe44ae74b">00251</a> <span class="keywordtype">int</span> <a class="code" href="group__VisBeat.html#ga918e331144008ce8808aa9abe44ae74b" title="Set the smartbeat parameter for a VisBeat.">visual_beat_set_smartbeat</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat, <span class="keywordtype">int</span> smartbeat)
<a name="l00252"></a>00252 {
<a name="l00253"></a>00253     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55bad01bdd685848e5513c06a0f0cb1faf27" title="The VisBeat is NULL.">VISUAL_ERROR_BEAT_NULL</a>);
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     beat-&gt;<a class="code" href="struct__VisBeat.html#a407fa89b37a9a521be1f1982a0b138d4">cfg_smartbeat</a> = smartbeat;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     <span class="keywordflow">return</span> <a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55ba73e463399cd84c08294d95cf0b4b7cf8" title="No error.">VISUAL_OK</a>;
<a name="l00258"></a>00258 }
<a name="l00259"></a>00259 
<a name="l00260"></a><a class="code" href="group__VisBeat.html#gafb23cbc118bcfcbdc5d76039c6c6a083">00260</a> <span class="keywordtype">int</span> <a class="code" href="group__VisBeat.html#gafb23cbc118bcfcbdc5d76039c6c6a083">visual_beat_set_smartbeat_sticky</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat, <span class="keywordtype">int</span> smartbeatsticky)
<a name="l00261"></a>00261 {
<a name="l00262"></a>00262     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55bad01bdd685848e5513c06a0f0cb1faf27" title="The VisBeat is NULL.">VISUAL_ERROR_BEAT_NULL</a>);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     beat-&gt;<a class="code" href="struct__VisBeat.html#addfdedc3e8acfb84a957bec2396ef1ac">cfg_smartbeatsticky</a> = smartbeatsticky;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="keywordflow">return</span> <a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55ba73e463399cd84c08294d95cf0b4b7cf8" title="No error.">VISUAL_OK</a>;
<a name="l00267"></a>00267 }
<a name="l00268"></a>00268 
<a name="l00269"></a><a class="code" href="group__VisBeat.html#ga5b8ec281e3fd29de1a921ec33645089c">00269</a> <span class="keywordtype">int</span> <a class="code" href="group__VisBeat.html#ga5b8ec281e3fd29de1a921ec33645089c" title="Set the smartbeat parameter for a VisBeat.">visual_beat_set_smartbeat_reset_on_newsong</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat, <span class="keywordtype">int</span> smartbeatresetnewsong)
<a name="l00270"></a>00270 {
<a name="l00271"></a>00271     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55bad01bdd685848e5513c06a0f0cb1faf27" title="The VisBeat is NULL.">VISUAL_ERROR_BEAT_NULL</a>);
<a name="l00272"></a>00272 
<a name="l00273"></a>00273     beat-&gt;<a class="code" href="struct__VisBeat.html#aa3cb47d96b9eb3883a90806e596bb06d">cfg_smartbeatresetnewsong</a> = smartbeatresetnewsong;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     <span class="keywordflow">return</span> <a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55ba73e463399cd84c08294d95cf0b4b7cf8" title="No error.">VISUAL_OK</a>;
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a><a class="code" href="group__VisBeat.html#gac0264562188fa02f8ca35021430b9f71">00278</a> <span class="keywordtype">int</span> <a class="code" href="group__VisBeat.html#gac0264562188fa02f8ca35021430b9f71" title="Set the smartbeat parameter for a VisBeat.">visual_beat_set_smartbeat_only_sticky</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat, <span class="keywordtype">int</span> smartbeatonlysticky)
<a name="l00279"></a>00279 {
<a name="l00280"></a>00280     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55bad01bdd685848e5513c06a0f0cb1faf27" title="The VisBeat is NULL.">VISUAL_ERROR_BEAT_NULL</a>);
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     beat-&gt;<a class="code" href="struct__VisBeat.html#a489bf8dce51a5719dc2033faab60a477">cfg_smartbeatonlysticky</a> = smartbeatonlysticky;
<a name="l00283"></a>00283 
<a name="l00284"></a>00284     <span class="keywordflow">return</span> <a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55ba73e463399cd84c08294d95cf0b4b7cf8" title="No error.">VISUAL_OK</a>;
<a name="l00285"></a>00285 }
<a name="l00286"></a>00286 
<a name="l00287"></a><a class="code" href="group__VisBeat.html#ga2c2b37d5c98d68808e99ffc73b8a6875">00287</a> <span class="keywordtype">int</span> <a class="code" href="group__VisBeat.html#ga2c2b37d5c98d68808e99ffc73b8a6875" title="Signal that the song has changed.">visual_beat_change_song</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat)
<a name="l00288"></a>00288 {
<a name="l00289"></a>00289     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55bad01bdd685848e5513c06a0f0cb1faf27" title="The VisBeat is NULL.">VISUAL_ERROR_BEAT_NULL</a>);
<a name="l00290"></a>00290 
<a name="l00291"></a>00291     beat-&gt;<a class="code" href="struct__VisBeat.html#a23a8154884634a0662e9ee50d15cd418">new_song</a> = <a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     <span class="keywordflow">return</span> <a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55ba73e463399cd84c08294d95cf0b4b7cf8" title="No error.">VISUAL_OK</a>;
<a name="l00294"></a>00294 }
<a name="l00295"></a>00295 
<a name="l00296"></a><a class="code" href="group__VisBeat.html#ga6d55a2078e3f720d5ccf1ed6a3ac7162">00296</a> <span class="keywordtype">char</span> *<a class="code" href="group__VisBeat.html#ga6d55a2078e3f720d5ccf1ed6a3ac7162" title="Retrive a formatted string indicating current BPM and confidence.">visual_beat_get_info</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat)
<a name="l00297"></a>00297 {
<a name="l00298"></a>00298     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat-&gt;<a class="code" href="struct__VisBeat.html#acbc1e2ebceeb1eae0e4ba1722a9d382c">txt</a> != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00301"></a>00301 
<a name="l00302"></a>00302     <span class="comment">/*if(beat-&gt;oldDisplayBpm != beat-&gt;predictionBpm || beat-&gt;oldsticked != beat-&gt;sticked)</span>
<a name="l00303"></a>00303 <span class="comment">    {</span>
<a name="l00304"></a>00304 <span class="comment">        beat-&gt;oldDisplayBpm = beat-&gt;predictionBpm;</span>
<a name="l00305"></a>00305 <span class="comment">        beat-&gt;oldsticked = beat-&gt;sticked;</span>
<a name="l00306"></a>00306 <span class="comment">    }</span>
<a name="l00307"></a>00307 <span class="comment"></span>
<a name="l00308"></a>00308 <span class="comment">    if(beat-&gt;oldDisplayConfidence != beat-&gt;confidence)</span>
<a name="l00309"></a>00309 <span class="comment">    {</span>
<a name="l00310"></a>00310 <span class="comment">        beat-&gt;oldDisplayConfidence = beat-&gt;confidence;</span>
<a name="l00311"></a>00311 <span class="comment">    }*/</span>
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a>) {
<a name="l00314"></a>00314         snprintf(beat-&gt;<a class="code" href="struct__VisBeat.html#acbc1e2ebceeb1eae0e4ba1722a9d382c">txt</a>, 255, <span class="stringliteral">&quot;Current BPM: %d%s&quot;</span>, beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a>,
<a name="l00315"></a>00315                  (beat-&gt;<a class="code" href="struct__VisBeat.html#addfdedc3e8acfb84a957bec2396ef1ac">cfg_smartbeatsticky</a> &amp;&amp; beat-&gt;<a class="code" href="struct__VisBeat.html#a82886870bf5bc25dae5ef0b6e42c20a6">sticked</a>) ? <span class="stringliteral">&quot; Got it!&quot;</span>: <span class="stringliteral">&quot;&quot;</span>);
<a name="l00316"></a>00316     } <span class="keywordflow">else</span> {
<a name="l00317"></a>00317         snprintf(beat-&gt;<a class="code" href="struct__VisBeat.html#acbc1e2ebceeb1eae0e4ba1722a9d382c">txt</a>, 255, <span class="stringliteral">&quot;Learning...&quot;</span>);
<a name="l00318"></a>00318     }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320     <span class="keywordtype">char</span> *tmp = <a class="code" href="lv__util_8c.html#a03b9550cd64165a627de6adcddfa4ccd">visual_strdup</a>(beat-&gt;<a class="code" href="struct__VisBeat.html#acbc1e2ebceeb1eae0e4ba1722a9d382c">txt</a>);
<a name="l00321"></a>00321     snprintf(beat-&gt;<a class="code" href="struct__VisBeat.html#acbc1e2ebceeb1eae0e4ba1722a9d382c">txt</a>, 255, <span class="stringliteral">&quot;%s -- Confidence: %d%%&quot;</span>, tmp, beat-&gt;<a class="code" href="struct__VisBeat.html#af7e674f80c3f59a2d00e749acc1ba7b5">confidence</a>);
<a name="l00322"></a>00322     <a class="code" href="group__VisMem.html#gad28e0c8516ddcb841d40b77259c78ed4" title="Frees allocated memory.">visual_mem_free</a>(tmp);
<a name="l00323"></a>00323 
<a name="l00324"></a>00324     <span class="keywordflow">return</span> beat-&gt;<a class="code" href="struct__VisBeat.html#acbc1e2ebceeb1eae0e4ba1722a9d382c">txt</a>;
<a name="l00325"></a>00325 }
<a name="l00326"></a>00326 
<a name="l00327"></a><a class="code" href="group__VisBeat.html#ga4a38754b9e1ee29e3c560636f4f4b816">00327</a> <span class="keywordtype">int</span> <a class="code" href="group__VisBeat.html#ga4a38754b9e1ee29e3c560636f4f4b816" title="Reset a VisBeat so that it may readapt.">visual_beat_reset_adapt</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat)
<a name="l00328"></a>00328 {
<a name="l00329"></a>00329     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55bad01bdd685848e5513c06a0f0cb1faf27" title="The VisBeat is NULL.">VISUAL_ERROR_BEAT_NULL</a>);
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <span class="comment">// Reset adaptive learning</span>
<a name="l00332"></a>00332     beat-&gt;<a class="code" href="struct__VisBeat.html#aa134a749e892cef51589db39f305941c">TCUsed</a>=0;
<a name="l00333"></a>00333     beat-&gt;<a class="code" href="struct__VisBeat.html#a22e288cdb9a4aacaf1b97ca11b13a0e1">hdPos</a>=0;
<a name="l00334"></a>00334     beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a> = 0;
<a name="l00335"></a>00335     beat-&gt;<a class="code" href="struct__VisBeat.html#af7e674f80c3f59a2d00e749acc1ba7b5">confidence</a>=0;
<a name="l00336"></a>00336     beat-&gt;<a class="code" href="struct__VisBeat.html#a4f46fb092b171f4261f52f34f0a94a91">confidence1</a>=0;
<a name="l00337"></a>00337     beat-&gt;<a class="code" href="struct__VisBeat.html#a589ca3cf9cccfca6146edbeed0ea822f">confidence2</a>=0;
<a name="l00338"></a>00338     beat-&gt;<a class="code" href="struct__VisBeat.html#a18e40f120fa7eff1ba423ca32c1ba91d">topConfidenceCount</a>=0;
<a name="l00339"></a>00339     beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a> = 0;
<a name="l00340"></a>00340     beat-&gt;<a class="code" href="struct__VisBeat.html#a2421bb95991710257ba3edf4070698d0">smPtr</a> = 0;
<a name="l00341"></a>00341     beat-&gt;<a class="code" href="struct__VisBeat.html#ad917cb1f0b7bb2893cab50db4470fc72">smSize</a> = 8;
<a name="l00342"></a>00342     beat-&gt;<a class="code" href="struct__VisBeat.html#a63e1ffa3a86be9480f31223fc383b3c2">offIMax</a> = 8;
<a name="l00343"></a>00343     beat-&gt;<a class="code" href="struct__VisBeat.html#a3da842c8e386925cb3b779aad495f398">insertionCount</a> = 0;
<a name="l00344"></a>00344     beat-&gt;<a class="code" href="struct__VisBeat.html#aad7a242bb1dbcf5858cc495a247c0149">predictionLastTC</a> = 0;
<a name="l00345"></a>00345     beat-&gt;<a class="code" href="struct__VisBeat.html#abf678935d2638bf5881650d846d14e39">halfCount</a>=0;
<a name="l00346"></a>00346     beat-&gt;<a class="code" href="struct__VisBeat.html#a28789b887916dc15129eac0a9f0b108a">doubleCount</a>=0;
<a name="l00347"></a>00347     beat-&gt;<a class="code" href="struct__VisBeat.html#a44cf259265ea344e2833cff7091c72a5">lastTC</a>= clock() / (float)CLOCKS_PER_SEC * 60000;
<a name="l00348"></a>00348     beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a> = 8;
<a name="l00349"></a>00349     beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a>=0;
<a name="l00350"></a>00350     beat-&gt;<a class="code" href="struct__VisBeat.html#ae35e852d6017591ea38d49db1e32954e">bestConfidence</a>=0;
<a name="l00351"></a>00351     beat-&gt;<a class="code" href="struct__VisBeat.html#a82886870bf5bc25dae5ef0b6e42c20a6">sticked</a>=0;
<a name="l00352"></a>00352     beat-&gt;<a class="code" href="struct__VisBeat.html#a0694f254081110d9ccc8db49a9fd280d">oldsticked</a>=-1;
<a name="l00353"></a>00353     beat-&gt;<a class="code" href="struct__VisBeat.html#ac7cdecc4ba18df6f8fbf2d0a69369084">stickyConfidenceCount</a>=0;
<a name="l00354"></a>00354     memset(beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>, 0, beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>*<span class="keyword">sizeof</span>(<a class="code" href="struct__VisBeatType.html">VisBeatType</a>));
<a name="l00355"></a>00355     memset(beat-&gt;<a class="code" href="struct__VisBeat.html#a46432ddabfe1b9d116a5facb83265fc9">smoother</a>, 0, beat-&gt;<a class="code" href="struct__VisBeat.html#ad917cb1f0b7bb2893cab50db4470fc72">smSize</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00356"></a>00356     memset(beat-&gt;<a class="code" href="struct__VisBeat.html#a67d9ffc8276f55527d9dc2d36e4f6e1e">half_discriminated</a>, 0, beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00357"></a>00357 
<a name="l00358"></a>00358     <span class="keywordflow">return</span> <a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55ba73e463399cd84c08294d95cf0b4b7cf8" title="No error.">VISUAL_OK</a>;
<a name="l00359"></a>00359 }
<a name="l00360"></a>00360 
<a name="l00361"></a><a class="code" href="group__VisBeat.html#ga0d5c95e5f8fe36ef4737d28448a14b0a">00361</a> <span class="keywordtype">int</span> <a class="code" href="group__VisBeat.html#ga0d5c95e5f8fe36ef4737d28448a14b0a">visual_beat_slider_get</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat, <a class="code" href="group__VisBeat.html#ga621628139708973e25f132feb46e010d">VisBeatSlider</a> slider)
<a name="l00362"></a>00362 {
<a name="l00363"></a>00363     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     <span class="keywordflow">return</span> slider == <a class="code" href="group__VisBeat.html#gga621628139708973e25f132feb46e010da522c1268ac2295c8efca4e7896619f6d">VISUAL_BEAT_SLIDE_IN</a> ? beat-&gt;<a class="code" href="struct__VisBeat.html#a501f230e14669672ce22996a49b15362">inInc</a> : beat-&gt;<a class="code" href="struct__VisBeat.html#a23d65d540f200b468799577b309d4603">outInc</a>;
<a name="l00366"></a>00366 }
<a name="l00367"></a>00367 
<a name="l00368"></a><a class="code" href="group__VisBeat.html#ga09f29ed42ffe6ee5a9dd215da5c5dff1">00368</a> <span class="keywordtype">int</span> <a class="code" href="group__VisBeat.html#ga09f29ed42ffe6ee5a9dd215da5c5dff1" title="Refine the beat indication through adaptive learning.">visual_beat_refine_beat</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat, <span class="keywordtype">int</span> isBeat)
<a name="l00369"></a>00369 {
<a name="l00370"></a>00370     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <span class="keywordtype">int</span> accepted=<a class="code" href="lv__defines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00373"></a>00373     <span class="keywordtype">int</span> predicted=<a class="code" href="lv__defines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00374"></a>00374     <span class="keywordtype">int</span> resyncin=<a class="code" href="lv__defines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00375"></a>00375     <span class="keywordtype">int</span> resyncout=<a class="code" href="lv__defines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00376"></a>00376     clock_t TCNow;
<a name="l00377"></a>00377 
<a name="l00378"></a>00378     TCNow = clock() / (float)CLOCKS_PER_SEC * 60000;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     <span class="keywordflow">if</span> (isBeat) <span class="comment">// Show the beat received from AVS</span>
<a name="l00381"></a>00381         <a class="code" href="lv__beat_8c.html#a7abe8c605152e709d8099878908fe39a">beat_slider_step</a>(beat, <a class="code" href="group__VisBeat.html#gga621628139708973e25f132feb46e010da522c1268ac2295c8efca4e7896619f6d">VISUAL_BEAT_SLIDE_IN</a>, &amp;beat-&gt;<a class="code" href="struct__VisBeat.html#a0cdc87440af5fea3c21fdc42f1fb48d5">inSlide</a>);
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="keywordflow">if</span> (<a class="code" href="lv__beat_8c.html#ad85c9e2bccf15de1ca00bc1ae721dbfa">beat_song_changed</a>(beat))
<a name="l00384"></a>00384     {
<a name="l00385"></a>00385         beat-&gt;<a class="code" href="struct__VisBeat.html#ae35e852d6017591ea38d49db1e32954e">bestConfidence</a>=(int)((<span class="keywordtype">float</span>)beat-&gt;<a class="code" href="struct__VisBeat.html#ae35e852d6017591ea38d49db1e32954e">bestConfidence</a>*0.5);
<a name="l00386"></a>00386         beat-&gt;<a class="code" href="struct__VisBeat.html#a82886870bf5bc25dae5ef0b6e42c20a6">sticked</a>=0;
<a name="l00387"></a>00387         beat-&gt;<a class="code" href="struct__VisBeat.html#ac7cdecc4ba18df6f8fbf2d0a69369084">stickyConfidenceCount</a>=0;
<a name="l00388"></a>00388         <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#aa3cb47d96b9eb3883a90806e596bb06d">cfg_smartbeatresetnewsong</a>)
<a name="l00389"></a>00389             <a class="code" href="group__VisBeat.html#ga4a38754b9e1ee29e3c560636f4f4b816" title="Reset a VisBeat so that it may readapt.">visual_beat_reset_adapt</a>(beat);
<a name="l00390"></a>00390     }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392     <span class="comment">// Try to predict if this frame should be a beat</span>
<a name="l00393"></a>00393     <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a> &amp;&amp; TCNow &gt; beat-&gt;<a class="code" href="struct__VisBeat.html#aad7a242bb1dbcf5858cc495a247c0149">predictionLastTC</a> + (60000 / beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a>))
<a name="l00394"></a>00394         predicted = <a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00395"></a>00395 
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     <span class="keywordflow">if</span> (isBeat) <span class="comment">// If it is a real beat, do discrimination/guessing and computations, then see if it is accepted</span>
<a name="l00398"></a>00398         accepted = <a class="code" href="lv__beat_8c.html#a4ea7d4d1aaad543af0816d54ba712fd8">beat_TC_hist_step</a>(beat, beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>, &amp;beat-&gt;<a class="code" href="struct__VisBeat.html#a22e288cdb9a4aacaf1b97ca11b13a0e1">hdPos</a>, TCNow, <a class="code" href="group__VisBeat.html#ga7c41d17bfd7187cda4fea0b155766733">BEAT_REAL</a>);
<a name="l00399"></a>00399 
<a name="l00400"></a>00400     <span class="comment">// Calculate current Bpm</span>
<a name="l00401"></a>00401     <a class="code" href="lv__beat_8c.html#a7099b46b01a082c806fa64cc9ca99dcf">beat_calc_bpm</a>(beat);
<a name="l00402"></a>00402 
<a name="l00403"></a>00403     <span class="comment">// If prediction Bpm has not yet been set</span>
<a name="l00404"></a>00404     <span class="comment">// or if prediction bpm is too high or too low</span>
<a name="l00405"></a>00405     <span class="comment">// or if 3/4 of our history buffer contains beats within the range of typical drift</span>
<a name="l00406"></a>00406     <span class="comment">// the accept the calculated Bpm as the new prediction Bpm</span>
<a name="l00407"></a>00407     <span class="comment">// This allows keeping the beat going on when the music fades out, and readapt to the new beat as soon as</span>
<a name="l00408"></a>00408     <span class="comment">// the music fades in again</span>
<a name="l00409"></a>00409     <span class="keywordflow">if</span> ((accepted || predicted) &amp;&amp; !beat-&gt;<a class="code" href="struct__VisBeat.html#a82886870bf5bc25dae5ef0b6e42c20a6">sticked</a> &amp;&amp; (!beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a> || beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a> &gt; <a class="code" href="group__VisBeat.html#ga412e4b0f77e15ac1ba266f22282a122b">BEAT_MAX_BPM</a> || beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a> &lt; <a class="code" href="group__VisBeat.html#ga9e1fcad8ef781c972001d3269511b670">BEAT_MIN_BPM</a>))
<a name="l00410"></a>00410     {
<a name="l00411"></a>00411         <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#af7e674f80c3f59a2d00e749acc1ba7b5">confidence</a> &gt;= beat-&gt;<a class="code" href="struct__VisBeat.html#ae35e852d6017591ea38d49db1e32954e">bestConfidence</a>)
<a name="l00412"></a>00412         {
<a name="l00413"></a>00413             beat-&gt;<a class="code" href="struct__VisBeat.html#a68eee14f066e94e38a01776a8c261a78">forceNewBeat</a>=1;
<a name="l00414"></a>00414         }
<a name="l00415"></a>00415         <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#af7e674f80c3f59a2d00e749acc1ba7b5">confidence</a> &gt;= 50)
<a name="l00416"></a>00416         {
<a name="l00417"></a>00417             beat-&gt;<a class="code" href="struct__VisBeat.html#a18e40f120fa7eff1ba423ca32c1ba91d">topConfidenceCount</a>++;
<a name="l00418"></a>00418             <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#a18e40f120fa7eff1ba423ca32c1ba91d">topConfidenceCount</a> == <a class="code" href="group__VisBeat.html#ga2dd8e6ae1e3681f76a9e41d11064d85d">BEAT_TOP_CONF_ADOPT</a>)
<a name="l00419"></a>00419             {
<a name="l00420"></a>00420                 beat-&gt;<a class="code" href="struct__VisBeat.html#a68eee14f066e94e38a01776a8c261a78">forceNewBeat</a>=1;
<a name="l00421"></a>00421                 beat-&gt;<a class="code" href="struct__VisBeat.html#a18e40f120fa7eff1ba423ca32c1ba91d">topConfidenceCount</a>=0;
<a name="l00422"></a>00422             }
<a name="l00423"></a>00423         }
<a name="l00424"></a>00424         <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#a68eee14f066e94e38a01776a8c261a78">forceNewBeat</a>)
<a name="l00425"></a>00425         {
<a name="l00426"></a>00426             beat-&gt;<a class="code" href="struct__VisBeat.html#a68eee14f066e94e38a01776a8c261a78">forceNewBeat</a>=0;
<a name="l00427"></a>00427             beat-&gt;<a class="code" href="struct__VisBeat.html#ae35e852d6017591ea38d49db1e32954e">bestConfidence</a> = beat-&gt;<a class="code" href="struct__VisBeat.html#af7e674f80c3f59a2d00e749acc1ba7b5">confidence</a>;
<a name="l00428"></a>00428             beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a>=beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a>;
<a name="l00429"></a>00429         }
<a name="l00430"></a>00430     }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432     <span class="keywordflow">if</span> (!beat-&gt;<a class="code" href="struct__VisBeat.html#a82886870bf5bc25dae5ef0b6e42c20a6">sticked</a>) beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a> = beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a>;
<a name="l00433"></a>00433     beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a>=beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a>;
<a name="l00434"></a>00434 
<a name="l00435"></a>00435 
<a name="l00436"></a>00436     <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a> &amp;&amp; accepted &amp;&amp; !predicted)
<a name="l00437"></a>00437     {
<a name="l00438"></a>00438         <span class="keywordtype">int</span> b = 0;
<a name="l00439"></a>00439         <span class="keywordflow">if</span> (TCNow &gt; beat-&gt;<a class="code" href="struct__VisBeat.html#aad7a242bb1dbcf5858cc495a247c0149">predictionLastTC</a> + (60000 / beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a>)*0.7)
<a name="l00440"></a>00440         {
<a name="l00441"></a>00441             resyncin = <a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00442"></a>00442             b = (int)((<span class="keywordtype">float</span>)beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a> * 1.01);
<a name="l00443"></a>00443         }
<a name="l00444"></a>00444         <span class="keywordflow">if</span> (TCNow &lt; beat-&gt;predictionLastTC + (60000 / beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a>)*0.3)
<a name="l00445"></a>00445         {
<a name="l00446"></a>00446             resyncout = <a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00447"></a>00447             b = (int)((<span class="keywordtype">float</span>)beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a> * 0.98);
<a name="l00448"></a>00448         }
<a name="l00449"></a>00449         <span class="keywordflow">if</span> (!beat-&gt;<a class="code" href="struct__VisBeat.html#a82886870bf5bc25dae5ef0b6e42c20a6">sticked</a> &amp;&amp; beat-&gt;<a class="code" href="struct__VisBeat.html#a8b94d653656fa3eaffcfbe819d7487bf">doResyncBpm</a> &amp;&amp; (resyncin || resyncout))
<a name="l00450"></a>00450         {
<a name="l00451"></a>00451             <a class="code" href="lv__beat_8c.html#ad52a77a0a59baebfd9b4b6199c16fa38">beat_new_bpm</a>(beat, b);
<a name="l00452"></a>00452             beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a> = <a class="code" href="lv__beat_8c.html#a31444d117345130ae44cf58cf75718c7">beat_get_bpm</a>(beat);
<a name="l00453"></a>00453         }
<a name="l00454"></a>00454     }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456     <span class="keywordflow">if</span> (resyncin)
<a name="l00457"></a>00457     {
<a name="l00458"></a>00458         beat-&gt;<a class="code" href="struct__VisBeat.html#aad7a242bb1dbcf5858cc495a247c0149">predictionLastTC</a> = TCNow;
<a name="l00459"></a>00459         <a class="code" href="lv__beat_8c.html#a7abe8c605152e709d8099878908fe39a">beat_slider_step</a>(beat, <a class="code" href="group__VisBeat.html#gga621628139708973e25f132feb46e010da56083be36e89b0455d08865d871cc759">VISUAL_BEAT_SLIDE_OUT</a>, &amp;beat-&gt;<a class="code" href="struct__VisBeat.html#af9939e4a88673e46246b3ba304f334ad">outSlide</a>);
<a name="l00460"></a>00460         beat-&gt;<a class="code" href="struct__VisBeat.html#a8b94d653656fa3eaffcfbe819d7487bf">doResyncBpm</a>=<a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00461"></a>00461         <span class="keywordflow">return</span> ((beat-&gt;<a class="code" href="struct__VisBeat.html#a407fa89b37a9a521be1f1982a0b138d4">cfg_smartbeat</a> &amp;&amp; !beat-&gt;<a class="code" href="struct__VisBeat.html#a489bf8dce51a5719dc2033faab60a477">cfg_smartbeatonlysticky</a>) ||
<a name="l00462"></a>00462             (beat-&gt;<a class="code" href="struct__VisBeat.html#a407fa89b37a9a521be1f1982a0b138d4">cfg_smartbeat</a> &amp;&amp; beat-&gt;<a class="code" href="struct__VisBeat.html#a489bf8dce51a5719dc2033faab60a477">cfg_smartbeatonlysticky</a> &amp;&amp; beat-&gt;<a class="code" href="struct__VisBeat.html#a82886870bf5bc25dae5ef0b6e42c20a6">sticked</a>)) ?
<a name="l00463"></a>00463             1 : isBeat;
<a name="l00464"></a>00464     }
<a name="l00465"></a>00465     <span class="keywordflow">if</span> (predicted)
<a name="l00466"></a>00466     {
<a name="l00467"></a>00467         beat-&gt;<a class="code" href="struct__VisBeat.html#aad7a242bb1dbcf5858cc495a247c0149">predictionLastTC</a> = TCNow;
<a name="l00468"></a>00468         <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#af7e674f80c3f59a2d00e749acc1ba7b5">confidence</a> &gt; 25)
<a name="l00469"></a>00469         <span class="comment">//accepted = beat_TC_hist_step(beat, beat-&gt;TCHist, &amp;beat-&gt;hdPos, TCNow, BEAT_REAL);</span>
<a name="l00470"></a>00470             <a class="code" href="lv__beat_8c.html#a4ea7d4d1aaad543af0816d54ba712fd8">beat_TC_hist_step</a>(beat, beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>, &amp;beat-&gt;<a class="code" href="struct__VisBeat.html#a22e288cdb9a4aacaf1b97ca11b13a0e1">hdPos</a>, TCNow, <a class="code" href="group__VisBeat.html#ga50b617887dff98708eb2360994787b54">BEAT_GUESSED</a>);
<a name="l00471"></a>00471         <a class="code" href="lv__beat_8c.html#a7abe8c605152e709d8099878908fe39a">beat_slider_step</a>(beat, <a class="code" href="group__VisBeat.html#gga621628139708973e25f132feb46e010da56083be36e89b0455d08865d871cc759">VISUAL_BEAT_SLIDE_OUT</a>, &amp;beat-&gt;<a class="code" href="struct__VisBeat.html#af9939e4a88673e46246b3ba304f334ad">outSlide</a>);
<a name="l00472"></a>00472         beat-&gt;<a class="code" href="struct__VisBeat.html#a8b94d653656fa3eaffcfbe819d7487bf">doResyncBpm</a>=<a class="code" href="lv__defines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00473"></a>00473         <span class="keywordflow">return</span> ((beat-&gt;<a class="code" href="struct__VisBeat.html#a407fa89b37a9a521be1f1982a0b138d4">cfg_smartbeat</a> &amp;&amp; !beat-&gt;<a class="code" href="struct__VisBeat.html#a489bf8dce51a5719dc2033faab60a477">cfg_smartbeatonlysticky</a>) ||
<a name="l00474"></a>00474             (beat-&gt;<a class="code" href="struct__VisBeat.html#a407fa89b37a9a521be1f1982a0b138d4">cfg_smartbeat</a> &amp;&amp; beat-&gt;<a class="code" href="struct__VisBeat.html#a489bf8dce51a5719dc2033faab60a477">cfg_smartbeatonlysticky</a> &amp;&amp; beat-&gt;<a class="code" href="struct__VisBeat.html#a82886870bf5bc25dae5ef0b6e42c20a6">sticked</a>)) ?
<a name="l00475"></a>00475             1 : isBeat;
<a name="l00476"></a>00476     }
<a name="l00477"></a>00477     <span class="keywordflow">if</span> (resyncout)
<a name="l00478"></a>00478     {
<a name="l00479"></a>00479         beat-&gt;<a class="code" href="struct__VisBeat.html#aad7a242bb1dbcf5858cc495a247c0149">predictionLastTC</a> = TCNow;
<a name="l00480"></a>00480         beat-&gt;<a class="code" href="struct__VisBeat.html#a8b94d653656fa3eaffcfbe819d7487bf">doResyncBpm</a>=<a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00481"></a>00481         <span class="keywordflow">return</span> ((beat-&gt;<a class="code" href="struct__VisBeat.html#a407fa89b37a9a521be1f1982a0b138d4">cfg_smartbeat</a> &amp;&amp; !beat-&gt;<a class="code" href="struct__VisBeat.html#a489bf8dce51a5719dc2033faab60a477">cfg_smartbeatonlysticky</a>) ||
<a name="l00482"></a>00482             (beat-&gt;<a class="code" href="struct__VisBeat.html#a407fa89b37a9a521be1f1982a0b138d4">cfg_smartbeat</a> &amp;&amp; beat-&gt;<a class="code" href="struct__VisBeat.html#a489bf8dce51a5719dc2033faab60a477">cfg_smartbeatonlysticky</a> &amp;&amp; beat-&gt;<a class="code" href="struct__VisBeat.html#a82886870bf5bc25dae5ef0b6e42c20a6">sticked</a>)) ?
<a name="l00483"></a>00483             0 : isBeat;
<a name="l00484"></a>00484     }
<a name="l00485"></a>00485 
<a name="l00486"></a>00486     <span class="keywordflow">return</span> ((beat-&gt;<a class="code" href="struct__VisBeat.html#a407fa89b37a9a521be1f1982a0b138d4">cfg_smartbeat</a> &amp;&amp; !beat-&gt;<a class="code" href="struct__VisBeat.html#a489bf8dce51a5719dc2033faab60a477">cfg_smartbeatonlysticky</a>) ||
<a name="l00487"></a>00487         (beat-&gt;<a class="code" href="struct__VisBeat.html#a407fa89b37a9a521be1f1982a0b138d4">cfg_smartbeat</a> &amp;&amp; beat-&gt;<a class="code" href="struct__VisBeat.html#a489bf8dce51a5719dc2033faab60a477">cfg_smartbeatonlysticky</a> &amp;&amp; beat-&gt;<a class="code" href="struct__VisBeat.html#a82886870bf5bc25dae5ef0b6e42c20a6">sticked</a>)) ?
<a name="l00488"></a>00488         (beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a> ? 0 : isBeat) : isBeat;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490 }
<a name="l00491"></a>00491 
<a name="l00492"></a><a class="code" href="group__VisBeat.html#ga23e63ab76f1f4aad1bebd568fe1aa7e7">00492</a> <a class="code" href="struct__VisBeatPeak.html">VisBeatPeak</a> *<a class="code" href="group__VisBeat.html#ga23e63ab76f1f4aad1bebd568fe1aa7e7" title="Retrieve the VisBeatPeak from a VisBeat.">visual_beat_get_peak</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat)
<a name="l00493"></a>00493 {
<a name="l00494"></a>00494     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00495"></a>00495 
<a name="l00496"></a>00496     <span class="keywordflow">return</span> &amp;beat-&gt;<a class="code" href="struct__VisBeat.html#a662a4b27b362cd75efc3f7954eb08c35">peak</a>;
<a name="l00497"></a>00497 }
<a name="l00498"></a>00498 
<a name="l00499"></a><a class="code" href="group__VisBeat.html#ga1e6b0cd1b5f5d3223105c71c34143633">00499</a> <a class="code" href="struct__VisBeatAdv.html">VisBeatAdv</a> *<a class="code" href="group__VisBeat.html#ga1e6b0cd1b5f5d3223105c71c34143633" title="Retrieve the VisBeatAdv from a VisBeat.">visual_beat_get_adv</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat)
<a name="l00500"></a>00500 {
<a name="l00501"></a>00501     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503     <span class="keywordflow">return</span> beat-&gt;<a class="code" href="struct__VisBeat.html#aa5d39195cbc9a3fb1ac1564980a1e84c">adv</a>;
<a name="l00504"></a>00504 }
<a name="l00505"></a>00505 
<a name="l00506"></a><a class="code" href="group__VisBeatAdv.html#gad0604da20426c83cdc907d1c6a373a35">00506</a> <span class="keywordtype">int</span> <a class="code" href="group__VisBeatAdv.html#gad0604da20426c83cdc907d1c6a373a35" title="Set the configuration parameters for a VisBeatAdv.">visual_beat_adv_set_config</a>(<a class="code" href="struct__VisBeatAdv.html">VisBeatAdv</a> *adv, <span class="keywordtype">int</span> sensitivity, <span class="keywordtype">int</span> max_bpm, <span class="keywordtype">int</span> thick_on_beats)
<a name="l00507"></a>00507 {
<a name="l00508"></a>00508     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(adv != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55baf892cb36cb1bf13623285ada18d55adb" title="The VisBeatAdv is NULL.">VISUAL_ERROR_BEAT_ADV_NULL</a>);
<a name="l00509"></a>00509 
<a name="l00510"></a>00510     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#a02294c3f2b6bb9d811862e0d4b640c52">cfg_sensitivity</a> = sensitivity;
<a name="l00511"></a>00511     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#ad8a748a912146dd521c1ff67efbf270e">cfg_max_detect</a> = max_bpm;
<a name="l00512"></a>00512     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#a1b71fcbe3d2c8a4cd5f6a85b1b775de8">cfg_thick_on_beats</a> = thick_on_beats;
<a name="l00513"></a>00513 
<a name="l00514"></a>00514     <span class="keywordflow">return</span> <a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55ba73e463399cd84c08294d95cf0b4b7cf8" title="No error.">VISUAL_OK</a>;
<a name="l00515"></a>00515 }
<a name="l00516"></a>00516 
<a name="l00517"></a><a class="code" href="group__VisBeatAdv.html#gab75a17965bf0589b7e61d1742727791f">00517</a> <span class="keywordtype">int</span> <a class="code" href="group__VisBeatAdv.html#gab75a17965bf0589b7e61d1742727791f" title="Set the sensitivy parameter for a VisBeatAdv.">visual_beat_adv_set_sensitivity</a>(<a class="code" href="struct__VisBeatAdv.html">VisBeatAdv</a> *adv, <span class="keywordtype">int</span> sensitivity)
<a name="l00518"></a>00518 {
<a name="l00519"></a>00519     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(adv != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55baf892cb36cb1bf13623285ada18d55adb" title="The VisBeatAdv is NULL.">VISUAL_ERROR_BEAT_ADV_NULL</a>);
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#a02294c3f2b6bb9d811862e0d4b640c52">cfg_sensitivity</a> = sensitivity;
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     <span class="keywordflow">return</span> <a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55ba73e463399cd84c08294d95cf0b4b7cf8" title="No error.">VISUAL_OK</a>;
<a name="l00524"></a>00524 }
<a name="l00525"></a>00525 
<a name="l00526"></a><a class="code" href="group__VisBeatAdv.html#ga8099825dd05e061e9721f74c7c1a81b7">00526</a> <span class="keywordtype">int</span> <a class="code" href="group__VisBeatAdv.html#ga8099825dd05e061e9721f74c7c1a81b7" title="Set the maximum BPM for a VisBeatAdv.">visual_beat_adv_set_max_detect</a>(<a class="code" href="struct__VisBeatAdv.html">VisBeatAdv</a> *adv, <span class="keywordtype">int</span> max_bpm)
<a name="l00527"></a>00527 {
<a name="l00528"></a>00528     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(adv != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55baf892cb36cb1bf13623285ada18d55adb" title="The VisBeatAdv is NULL.">VISUAL_ERROR_BEAT_ADV_NULL</a>);
<a name="l00529"></a>00529 
<a name="l00530"></a>00530     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#ad8a748a912146dd521c1ff67efbf270e">cfg_max_detect</a> = max_bpm;
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     <span class="keywordflow">return</span> <a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55ba73e463399cd84c08294d95cf0b4b7cf8" title="No error.">VISUAL_OK</a>;
<a name="l00533"></a>00533 }
<a name="l00534"></a>00534 
<a name="l00535"></a><a class="code" href="group__VisBeatAdv.html#gafd3926ccc814fc6352b5cead58d70f81">00535</a> <span class="keywordtype">int</span> <a class="code" href="group__VisBeatAdv.html#gafd3926ccc814fc6352b5cead58d70f81" title="Set the thick on beats parameter for a VisBeatAdv.">visual_beat_adv_set_thick_on_beats</a>(<a class="code" href="struct__VisBeatAdv.html">VisBeatAdv</a> *adv, <span class="keywordtype">int</span> thick_on_beats)
<a name="l00536"></a>00536 {
<a name="l00537"></a>00537     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(adv != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55baf892cb36cb1bf13623285ada18d55adb" title="The VisBeatAdv is NULL.">VISUAL_ERROR_BEAT_ADV_NULL</a>);
<a name="l00538"></a>00538 
<a name="l00539"></a>00539     adv-&gt;<a class="code" href="struct__VisBeatAdv.html#a1b71fcbe3d2c8a4cd5f6a85b1b775de8">cfg_thick_on_beats</a> = thick_on_beats;
<a name="l00540"></a>00540 
<a name="l00541"></a>00541     <span class="keywordflow">return</span> <a class="code" href="group__VisError.html#gga06fc87d81c62e9abb8790b6e5713c55ba73e463399cd84c08294d95cf0b4b7cf8" title="No error.">VISUAL_OK</a>;
<a name="l00542"></a>00542 }
<a name="l00543"></a>00543 
<a name="l00544"></a>00544 <span class="comment">// The song changed or not. User sets flag with visual_beat_change_song()</span>
<a name="l00545"></a><a class="code" href="lv__beat_8c.html#ad85c9e2bccf15de1ca00bc1ae721dbfa">00545</a> <span class="keywordtype">int</span> <a class="code" href="lv__beat_8c.html#ad85c9e2bccf15de1ca00bc1ae721dbfa">beat_song_changed</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat)
<a name="l00546"></a>00546 {
<a name="l00547"></a>00547     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="lv__defines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00548"></a>00548 
<a name="l00549"></a>00549     <span class="keywordflow">if</span>(beat-&gt;<a class="code" href="struct__VisBeat.html#a23a8154884634a0662e9ee50d15cd418">new_song</a>)
<a name="l00550"></a>00550     {
<a name="l00551"></a>00551     beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a> = 0;
<a name="l00552"></a>00552         beat-&gt;<a class="code" href="struct__VisBeat.html#a23a8154884634a0662e9ee50d15cd418">new_song</a> = <a class="code" href="lv__defines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00553"></a>00553         <span class="keywordflow">return</span> <a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00554"></a>00554     }
<a name="l00555"></a>00555     <span class="keywordflow">return</span> <a class="code" href="lv__defines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00556"></a>00556 }
<a name="l00557"></a>00557 
<a name="l00558"></a>00558 <span class="comment">// Insert a beat in history table. May be either real beat or guessed</span>
<a name="l00559"></a><a class="code" href="lv__beat_8c.html#ac3c27ceae000a424a6200b793dfb3f78">00559</a> <span class="keywordtype">void</span> <a class="code" href="lv__beat_8c.html#ac3c27ceae000a424a6200b793dfb3f78">beat_insert_hist_step</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat, <a class="code" href="struct__VisBeatType.html">VisBeatType</a> *t, clock_t TC, <span class="keywordtype">int</span> type, <span class="keywordtype">int</span> i)
<a name="l00560"></a>00560 {
<a name="l00561"></a>00561     <a class="code" href="lv__checks_8h.html#a2a00268a7d0b3c9329a1d85c3cca4e70" title="Return if expr is FALSE, showing a critical message with useful information.">visual_return_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00562"></a>00562 
<a name="l00563"></a>00563     <span class="keywordflow">if</span> (i &gt;= beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>) <span class="keywordflow">return</span>;
<a name="l00564"></a>00564     <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#a3da842c8e386925cb3b779aad495f398">insertionCount</a> &lt; beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>*2)
<a name="l00565"></a>00565         beat-&gt;<a class="code" href="struct__VisBeat.html#a3da842c8e386925cb3b779aad495f398">insertionCount</a>++;
<a name="l00566"></a>00566     memmove(t+i+1, t+i, <span class="keyword">sizeof</span>(<a class="code" href="struct__VisBeatType.html">VisBeatType</a>)*(beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>-(i+1)));
<a name="l00567"></a>00567     t[0].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a> = TC;
<a name="l00568"></a>00568     t[0].<a class="code" href="struct__VisBeatType.html#a895c18dc63395f41d2c9b6515e94ef4e">type</a> = type;
<a name="l00569"></a>00569 }
<a name="l00570"></a>00570 
<a name="l00571"></a>00571 <span class="comment">// Doubles current beat</span>
<a name="l00572"></a><a class="code" href="lv__beat_8c.html#a329ee39f88e8a43f970abc9157d088b9">00572</a> <span class="keywordtype">void</span> <a class="code" href="lv__beat_8c.html#a329ee39f88e8a43f970abc9157d088b9">beat_double_beat</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat)
<a name="l00573"></a>00573 {
<a name="l00574"></a>00574     <a class="code" href="lv__checks_8h.html#a2a00268a7d0b3c9329a1d85c3cca4e70" title="Return if expr is FALSE, showing a critical message with useful information.">visual_return_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00575"></a>00575 
<a name="l00576"></a>00576     <span class="keywordtype">int</span> i;
<a name="l00577"></a>00577     <span class="keywordtype">int</span> iv[8];
<a name="l00578"></a>00578 
<a name="l00579"></a>00579     <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#a82886870bf5bc25dae5ef0b6e42c20a6">sticked</a> &amp;&amp; beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a> &gt; <a class="code" href="group__VisBeat.html#ga9e1fcad8ef781c972001d3269511b670">BEAT_MIN_BPM</a>)
<a name="l00580"></a>00580         <span class="keywordflow">return</span>;
<a name="l00581"></a>00581 
<a name="l00582"></a>00582     <span class="keywordflow">for</span> (i=0;i&lt;beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>-1;i++)
<a name="l00583"></a>00583         iv[i] = beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>[i].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a> - beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>[i+1].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a>;
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     for (i=1;i&lt;beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>;i++)
<a name="l00586"></a>00586         beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>[i].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a> = beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>[i-1].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a>-iv[i-1]/2;
<a name="l00587"></a>00587 
<a name="l00588"></a>00588     beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a> /= 2;
<a name="l00589"></a>00589     beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a> *= 2;
<a name="l00590"></a>00590     beat-&gt;<a class="code" href="struct__VisBeat.html#a28789b887916dc15129eac0a9f0b108a">doubleCount</a>=0;
<a name="l00591"></a>00591     memset(beat-&gt;<a class="code" href="struct__VisBeat.html#a46432ddabfe1b9d116a5facb83265fc9">smoother</a>, 0, beat-&gt;<a class="code" href="struct__VisBeat.html#ad917cb1f0b7bb2893cab50db4470fc72">smSize</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00592"></a>00592     memset(beat-&gt;<a class="code" href="struct__VisBeat.html#a67d9ffc8276f55527d9dc2d36e4f6e1e">half_discriminated</a>, 0, beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00593"></a>00593 }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595 <span class="comment">// Halfs current beat</span>
<a name="l00596"></a><a class="code" href="lv__beat_8c.html#a909c7620df5bc4053636c33a54a266f1">00596</a> <span class="keywordtype">void</span> <a class="code" href="lv__beat_8c.html#a909c7620df5bc4053636c33a54a266f1">beat_half_beat</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat)
<a name="l00597"></a>00597 {
<a name="l00598"></a>00598     <a class="code" href="lv__checks_8h.html#a2a00268a7d0b3c9329a1d85c3cca4e70" title="Return if expr is FALSE, showing a critical message with useful information.">visual_return_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00599"></a>00599 
<a name="l00600"></a>00600     <span class="keywordtype">int</span> i;
<a name="l00601"></a>00601     <span class="keywordtype">int</span> iv[8];
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#a82886870bf5bc25dae5ef0b6e42c20a6">sticked</a> &amp;&amp; beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a> &lt; <a class="code" href="group__VisBeat.html#ga9e1fcad8ef781c972001d3269511b670">BEAT_MIN_BPM</a>) <span class="keywordflow">return</span>;
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     <span class="keywordflow">for</span> (i=0;i&lt;beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>-1;i++)
<a name="l00606"></a>00606         iv[i] = beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>[i].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a> - beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>[i+1].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a>;
<a name="l00607"></a>00607 
<a name="l00608"></a>00608     for (i=1;i&lt;beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>;i++)
<a name="l00609"></a>00609         beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>[i].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a> = beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>[i-1].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a>-iv[i-1]*2;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611     beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a> *= 2;
<a name="l00612"></a>00612     beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a> /= 2;
<a name="l00613"></a>00613     beat-&gt;<a class="code" href="struct__VisBeat.html#abf678935d2638bf5881650d846d14e39">halfCount</a>=0;
<a name="l00614"></a>00614     memset(beat-&gt;<a class="code" href="struct__VisBeat.html#a46432ddabfe1b9d116a5facb83265fc9">smoother</a>, 0, beat-&gt;<a class="code" href="struct__VisBeat.html#ad917cb1f0b7bb2893cab50db4470fc72">smSize</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00615"></a>00615     memset(beat-&gt;<a class="code" href="struct__VisBeat.html#a67d9ffc8276f55527d9dc2d36e4f6e1e">half_discriminated</a>, 0, beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00616"></a>00616 }
<a name="l00617"></a>00617 
<a name="l00618"></a>00618 <span class="comment">// Called whenever isBeat was true in render</span>
<a name="l00619"></a>00619 <span class="comment">//        accepted = beat_TC_hist_step(beat, beat-&gt;TCHist, &amp;beat-&gt;hdPos, TCNow, BEAT_REAL);</span>
<a name="l00620"></a>00620 <span class="comment">//            beat_TC_hist_step(beat, beat-&gt;TCHist, &amp;beat-&gt;hdPos, TCNow, BEAT_GUESSED);</span>
<a name="l00621"></a>00621 
<a name="l00622"></a><a class="code" href="lv__beat_8c.html#a4ea7d4d1aaad543af0816d54ba712fd8">00622</a> <span class="keywordtype">int</span> <a class="code" href="lv__beat_8c.html#a4ea7d4d1aaad543af0816d54ba712fd8">beat_TC_hist_step</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat, <a class="code" href="struct__VisBeatType.html">VisBeatType</a> *t, <span class="keywordtype">int</span> *_hdPos, clock_t TC, <span class="keywordtype">int</span> type)
<a name="l00623"></a>00623 {
<a name="l00624"></a>00624     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="lv__defines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00625"></a>00625 
<a name="l00626"></a>00626     <span class="keywordtype">int</span> offI;
<a name="l00627"></a>00627     clock_t thisLen;
<a name="l00628"></a>00628     <span class="keywordtype">int</span> learning = <a class="code" href="lv__beat_8c.html#a4c5e0811cce5e73f38342a26d0e1594e">beat_ready_to_learn</a>(beat);
<a name="l00629"></a>00629     thisLen = TC - beat-&gt;<a class="code" href="struct__VisBeat.html#a44cf259265ea344e2833cff7091c72a5">lastTC</a>;
<a name="l00630"></a>00630     thisLen = thisLen&gt;=0?thisLen:0;
<a name="l00631"></a>00631 
<a name="l00632"></a>00632     <span class="comment">// If this beat is sooner than half the average - 20%, throw it away</span>
<a name="l00633"></a>00633     <span class="keywordflow">if</span> (thisLen &lt; beat-&gt;avg/2 - beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a>*0.1)
<a name="l00634"></a>00634     {
<a name="l00635"></a>00635         <span class="keywordflow">if</span> (learning)
<a name="l00636"></a>00636         {
<a name="l00637"></a>00637             <span class="keywordflow">if</span> (abs(beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a> - (TC - t[1].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a>)) &lt; abs(beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a> - (t[0].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a> - t[1].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a>)))
<a name="l00638"></a>00638             {
<a name="l00639"></a>00639                 printf(<span class="stringliteral">&quot;inside level 3\n&quot;</span>);
<a name="l00640"></a>00640                 t-&gt;<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a> = TC;
<a name="l00641"></a>00641                 t-&gt;<a class="code" href="struct__VisBeatType.html#a895c18dc63395f41d2c9b6515e94ef4e">type</a> = type;
<a name="l00642"></a>00642                 <span class="keywordflow">return</span> <a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00643"></a>00643             }
<a name="l00644"></a>00644         }
<a name="l00645"></a>00645         <span class="keywordflow">return</span> <a class="code" href="lv__defines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00646"></a>00646     }
<a name="l00647"></a>00647     <span class="keywordflow">if</span> (learning)
<a name="l00648"></a>00648       <span class="keywordflow">for</span> (offI = 2; offI &lt; beat-&gt;<a class="code" href="struct__VisBeat.html#a63e1ffa3a86be9480f31223fc383b3c2">offIMax</a>; offI++) <span class="comment">// Try to see if this beat is in the middle of our current Bpm, or maybe 1/3, 1/4 etc... to offIMax</span>
<a name="l00649"></a>00649         <span class="keywordflow">if</span> ((<span class="keywordtype">float</span>)abs((beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a>/offI)-thisLen) &lt; (<span class="keywordtype">float</span>)(beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a>/offI)*0.2)
<a name="l00650"></a>00650         {
<a name="l00651"></a>00651             beat-&gt;<a class="code" href="struct__VisBeat.html#a67d9ffc8276f55527d9dc2d36e4f6e1e">half_discriminated</a>[(*_hdPos)++]=1; <span class="comment">// Should test if offI==2 before doing that, but seems to have better results ? I&#39;ll have to investigate this</span>
<a name="l00652"></a>00652             (*_hdPos)%=8;
<a name="l00653"></a>00653             <span class="keywordflow">return</span> <a class="code" href="lv__defines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00654"></a>00654         }
<a name="l00655"></a>00655 
<a name="l00656"></a>00656     <span class="comment">// This beat is accepted, so set this discrimination entry to false</span>
<a name="l00657"></a>00657     beat-&gt;<a class="code" href="struct__VisBeat.html#a67d9ffc8276f55527d9dc2d36e4f6e1e">half_discriminated</a>[beat-&gt;<a class="code" href="struct__VisBeat.html#a22e288cdb9a4aacaf1b97ca11b13a0e1">hdPos</a>++]=0;
<a name="l00658"></a>00658     (*_hdPos)%=8;
<a name="l00659"></a>00659 
<a name="l00660"></a>00660     <span class="comment">// Remember this tick count</span>
<a name="l00661"></a>00661     beat-&gt;<a class="code" href="struct__VisBeat.html#a44cf259265ea344e2833cff7091c72a5">lastTC</a> = TC + beat-&gt;<a class="code" href="struct__VisBeat.html#afb8a465dd3c94b10a1c84aa150dddf6b">startTC</a>;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663     <span class="comment">// Insert this beat.</span>
<a name="l00664"></a>00664     <a class="code" href="lv__beat_8c.html#ac3c27ceae000a424a6200b793dfb3f78">beat_insert_hist_step</a>(beat, t, TC, type, 0);
<a name="l00665"></a>00665     <span class="keywordflow">return</span> <a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00666"></a>00666 }
<a name="l00667"></a>00667 
<a name="l00668"></a>00668 <span class="comment">// Am i ready to learn ?</span>
<a name="l00669"></a><a class="code" href="lv__beat_8c.html#a4c5e0811cce5e73f38342a26d0e1594e">00669</a> <span class="keywordtype">int</span> <a class="code" href="lv__beat_8c.html#a4c5e0811cce5e73f38342a26d0e1594e">beat_ready_to_learn</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat)
<a name="l00670"></a>00670 {
<a name="l00671"></a>00671     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="lv__defines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00672"></a>00672 
<a name="l00673"></a>00673     <span class="keywordtype">int</span> i;
<a name="l00674"></a>00674     <span class="keywordflow">for</span> (i=0; i &lt; beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>;i++)
<a name="l00675"></a>00675         <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>[i].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a>==0)
<a name="l00676"></a>00676             <span class="keywordflow">return</span> <a class="code" href="lv__defines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00677"></a>00677     <span class="keywordflow">return</span> <a class="code" href="lv__defines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00678"></a>00678 }
<a name="l00679"></a>00679 
<a name="l00680"></a>00680 <span class="comment">// Am i ready to guess ?</span>
<a name="l00681"></a><a class="code" href="lv__beat_8c.html#a640ff532a811c57ce81fc3cfaab120a4">00681</a> <span class="keywordtype">int</span> <a class="code" href="lv__beat_8c.html#a640ff532a811c57ce81fc3cfaab120a4">beat_ready_to_guess</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat)
<a name="l00682"></a>00682 {
<a name="l00683"></a>00683     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="lv__defines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00684"></a>00684 
<a name="l00685"></a>00685     <span class="keywordflow">return</span> beat-&gt;<a class="code" href="struct__VisBeat.html#a3da842c8e386925cb3b779aad495f398">insertionCount</a> == beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>*2;
<a name="l00686"></a>00686 }
<a name="l00687"></a>00687 
<a name="l00688"></a><a class="code" href="lv__beat_8c.html#ad52a77a0a59baebfd9b4b6199c16fa38">00688</a> <span class="keywordtype">void</span> <a class="code" href="lv__beat_8c.html#ad52a77a0a59baebfd9b4b6199c16fa38">beat_new_bpm</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat, <span class="keywordtype">int</span> thisBpm)
<a name="l00689"></a>00689 {
<a name="l00690"></a>00690     <a class="code" href="lv__checks_8h.html#a2a00268a7d0b3c9329a1d85c3cca4e70" title="Return if expr is FALSE, showing a critical message with useful information.">visual_return_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00691"></a>00691 
<a name="l00692"></a>00692     beat-&gt;<a class="code" href="struct__VisBeat.html#a46432ddabfe1b9d116a5facb83265fc9">smoother</a>[beat-&gt;<a class="code" href="struct__VisBeat.html#a2421bb95991710257ba3edf4070698d0">smPtr</a>++] = thisBpm;
<a name="l00693"></a>00693     beat-&gt;<a class="code" href="struct__VisBeat.html#a2421bb95991710257ba3edf4070698d0">smPtr</a> %= beat-&gt;<a class="code" href="struct__VisBeat.html#ad917cb1f0b7bb2893cab50db4470fc72">smSize</a>;
<a name="l00694"></a>00694 }
<a name="l00695"></a>00695 
<a name="l00696"></a><a class="code" href="lv__beat_8c.html#a31444d117345130ae44cf58cf75718c7">00696</a> <span class="keywordtype">int</span> <a class="code" href="lv__beat_8c.html#a31444d117345130ae44cf58cf75718c7">beat_get_bpm</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat)
<a name="l00697"></a>00697 {
<a name="l00698"></a>00698     <a class="code" href="lv__checks_8h.html#a34012d2243c29a51364c5c335781d572" title="Return if val if expr is FALSE, showing a critical message with useful information.">visual_return_val_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l00699"></a>00699 
<a name="l00700"></a>00700     <span class="keywordtype">int</span> i;
<a name="l00701"></a>00701     <span class="keywordtype">int</span> smN=0;
<a name="l00702"></a>00702     <span class="keywordtype">int</span> smSum=0;
<a name="l00703"></a>00703     <span class="comment">// Calculate smoothed Bpm</span>
<a name="l00704"></a>00704     <span class="keywordflow">for</span> (i=0;i&lt;beat-&gt;<a class="code" href="struct__VisBeat.html#ad917cb1f0b7bb2893cab50db4470fc72">smSize</a>;i++)
<a name="l00705"></a>00705         <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#a46432ddabfe1b9d116a5facb83265fc9">smoother</a>[i] &gt; 0)
<a name="l00706"></a>00706         {
<a name="l00707"></a>00707             smSum += beat-&gt;<a class="code" href="struct__VisBeat.html#a46432ddabfe1b9d116a5facb83265fc9">smoother</a>[i];
<a name="l00708"></a>00708             smN++;
<a name="l00709"></a>00709         }
<a name="l00710"></a>00710     <span class="keywordflow">if</span> (smN)
<a name="l00711"></a>00711         <span class="keywordflow">return</span> smSum / smN;
<a name="l00712"></a>00712     <span class="keywordflow">return</span> 0;
<a name="l00713"></a>00713 }
<a name="l00714"></a>00714 
<a name="l00715"></a>00715 <span class="comment">// Calculate BPM according to beat history</span>
<a name="l00716"></a><a class="code" href="lv__beat_8c.html#a7099b46b01a082c806fa64cc9ca99dcf">00716</a> <span class="keywordtype">void</span> <a class="code" href="lv__beat_8c.html#a7099b46b01a082c806fa64cc9ca99dcf">beat_calc_bpm</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat)
<a name="l00717"></a>00717 {
<a name="l00718"></a>00718     <a class="code" href="lv__checks_8h.html#a2a00268a7d0b3c9329a1d85c3cca4e70" title="Return if expr is FALSE, showing a critical message with useful information.">visual_return_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00719"></a>00719 
<a name="l00720"></a>00720     <span class="keywordtype">int</span> i;
<a name="l00721"></a>00721     <span class="keywordtype">int</span> hdCount=0;
<a name="l00722"></a>00722     <span class="keywordtype">int</span> r=0;
<a name="l00723"></a>00723     <span class="keywordtype">int</span> totalTC=0, totalN=0;
<a name="l00724"></a>00724     <span class="keywordtype">float</span> rC, etC;
<a name="l00725"></a>00725     <span class="keywordtype">int</span> v=0;
<a name="l00726"></a>00726     <span class="keywordtype">double</span> sc=0;
<a name="l00727"></a>00727     <span class="keywordtype">int</span> mx=0;
<a name="l00728"></a>00728     <span class="keywordtype">float</span> et;
<a name="l00729"></a>00729 
<a name="l00730"></a>00730     <span class="keywordflow">if</span> (!<a class="code" href="lv__beat_8c.html#a4c5e0811cce5e73f38342a26d0e1594e">beat_ready_to_learn</a>(beat))
<a name="l00731"></a>00731         <span class="keywordflow">return</span>;
<a name="l00732"></a>00732 
<a name="l00733"></a>00733     <span class="comment">// First calculate average beat</span>
<a name="l00734"></a>00734     <span class="keywordflow">for</span> (i=0;i&lt;beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>-1;i++)
<a name="l00735"></a>00735         totalTC += beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>[i].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a> - beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>[i+1].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a>;
<a name="l00736"></a>00736 
<a name="l00737"></a>00737     beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a> = totalTC/(beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>-1);
<a name="l00738"></a>00738 
<a name="l00739"></a>00739     <span class="comment">// Count how many of then are real as opposed to guessed</span>
<a name="l00740"></a>00740     <span class="keywordflow">for</span> (i=0;i&lt;beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>;i++)
<a name="l00741"></a>00741         <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>[i].<a class="code" href="struct__VisBeatType.html#a895c18dc63395f41d2c9b6515e94ef4e">type</a> == <a class="code" href="group__VisBeat.html#ga7c41d17bfd7187cda4fea0b155766733">BEAT_REAL</a>)
<a name="l00742"></a>00742             r++;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     <span class="comment">// Calculate part 1 of confidence</span>
<a name="l00745"></a>00745     rC = (float)<a class="code" href="lv__beat_8c.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>((<span class="keywordtype">float</span>)((float)r / (<span class="keywordtype">float</span>)beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>) * 2, 1);
<a name="l00746"></a>00746 
<a name="l00747"></a>00747     <span class="comment">// Calculate typical drift</span>
<a name="l00748"></a>00748     <span class="keywordflow">for</span> (i=0;i&lt;beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>-1;i++)
<a name="l00749"></a>00749     {
<a name="l00750"></a>00750         v = beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>[i].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a> - beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>[i+1].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a>;
<a name="l00751"></a>00751         mx = <a class="code" href="lv__beat_8c.html#affe776513b24d84b39af8ab0930fef7f">max</a>(mx, v);
<a name="l00752"></a>00752         sc += v*v;
<a name="l00753"></a>00753     }
<a name="l00754"></a>00754     et = (float)sqrt(sc / (beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>-1) - beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a>*beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a>);
<a name="l00755"></a>00755     <span class="comment">// Calculate confidence based on typical drift and max derivation</span>
<a name="l00756"></a>00756     etC = 1 - ((float)et / (<span class="keywordtype">float</span>)mx);
<a name="l00757"></a>00757 
<a name="l00758"></a>00758     <span class="comment">// Calculate confidence</span>
<a name="l00759"></a>00759     beat-&gt;<a class="code" href="struct__VisBeat.html#af7e674f80c3f59a2d00e749acc1ba7b5">confidence</a> = <a class="code" href="lv__beat_8c.html#affe776513b24d84b39af8ab0930fef7f">max</a>(0, (<span class="keywordtype">int</span>)(((rC * etC) * 100.0) - 50) * 2);
<a name="l00760"></a>00760     beat-&gt;<a class="code" href="struct__VisBeat.html#a4f46fb092b171f4261f52f34f0a94a91">confidence1</a> = (int)(rC * 100);
<a name="l00761"></a>00761     beat-&gt;<a class="code" href="struct__VisBeat.html#a589ca3cf9cccfca6146edbeed0ea822f">confidence2</a> = (int)(etC * 100);
<a name="l00762"></a>00762 
<a name="l00763"></a>00763     <span class="comment">// Now apply second layer, recalculate average using only beats within range of typical drift</span>
<a name="l00764"></a>00764     <span class="comment">// Also, count how many of them we are keeping</span>
<a name="l00765"></a>00765     totalTC=0;
<a name="l00766"></a>00766     <span class="keywordflow">for</span> (i=0;i&lt;beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>-1;i++)
<a name="l00767"></a>00767     {
<a name="l00768"></a>00768         v += beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>[i].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a> - beat-&gt;<a class="code" href="struct__VisBeat.html#a38d107bd8da570f5d75075c8efa2027b">TCHist</a>[i+1].<a class="code" href="struct__VisBeatType.html#aae8d17b8ef2c59bf47656f53e0667dd0">TC</a>;
<a name="l00769"></a>00769         <span class="keywordflow">if</span> (abs(beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a>-v) &lt; et)
<a name="l00770"></a>00770         {
<a name="l00771"></a>00771             totalTC += v;
<a name="l00772"></a>00772             totalN++;
<a name="l00773"></a>00773             v = 0;
<a name="l00774"></a>00774         }
<a name="l00775"></a>00775         <span class="keywordflow">else</span>
<a name="l00776"></a>00776             <span class="keywordflow">if</span> ((<span class="keywordtype">float</span>)v &gt; beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a>)
<a name="l00777"></a>00777                 v = 0;
<a name="l00778"></a>00778     }
<a name="l00779"></a>00779     beat-&gt;<a class="code" href="struct__VisBeat.html#aa134a749e892cef51589db39f305941c">TCUsed</a> = totalN;
<a name="l00780"></a>00780     <span class="comment">// If no beat was within typical drift (how would it be possible? well lets cover our ass) then keep the simple</span>
<a name="l00781"></a>00781     <span class="comment">// average calculated earlier, else recalculate average of beats within range</span>
<a name="l00782"></a>00782     <span class="keywordflow">if</span> (totalN)
<a name="l00783"></a>00783         beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a> = totalTC/totalN;
<a name="l00784"></a>00784 
<a name="l00785"></a>00785     <span class="keywordflow">if</span> (<a class="code" href="lv__beat_8c.html#a640ff532a811c57ce81fc3cfaab120a4">beat_ready_to_guess</a>(beat))
<a name="l00786"></a>00786     {
<a name="l00787"></a>00787         <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a>) <span class="comment">// Avg = 0 ? Ahem..</span>
<a name="l00788"></a>00788             beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a> = 60000 / beat-&gt;<a class="code" href="struct__VisBeat.html#a77d9389d4df38844f0a6bdabf996ba5b">avg</a>;
<a name="l00789"></a>00789 
<a name="l00790"></a>00790 
<a name="l00791"></a>00791         <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a> != beat-&gt;<a class="code" href="struct__VisBeat.html#ab4bea39e61def4d372d42886d80b7d62">lastBPM</a>)
<a name="l00792"></a>00792         {
<a name="l00793"></a>00793             <a class="code" href="lv__beat_8c.html#ad52a77a0a59baebfd9b4b6199c16fa38">beat_new_bpm</a>(beat, beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a>); <span class="comment">// If realtime Bpm has changed since last time, then insert it in the smoothing tab;e</span>
<a name="l00794"></a>00794             beat-&gt;<a class="code" href="struct__VisBeat.html#ab4bea39e61def4d372d42886d80b7d62">lastBPM</a> = beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a>;
<a name="l00795"></a>00795 
<a name="l00796"></a>00796             <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#addfdedc3e8acfb84a957bec2396ef1ac">cfg_smartbeatsticky</a> &amp;&amp; beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a> &amp;&amp; beat-&gt;<a class="code" href="struct__VisBeat.html#af7e674f80c3f59a2d00e749acc1ba7b5">confidence</a> &gt;= ((beat-&gt;<a class="code" href="struct__VisBeat.html#ab9b6bdbf9282412d06077f6c923f4c22">predictionBpm</a> &lt; 90) ? <a class="code" href="group__VisBeat.html#ga12b7c2a342486ae3f7efcd8e32fe0585">BEAT_STICKY_THRESHOLD_LOW</a> : <a class="code" href="group__VisBeat.html#ga0fd875446eb1daa859469bdc1e8df6ec">BEAT_STICKY_THRESHOLD</a>))
<a name="l00797"></a>00797             {
<a name="l00798"></a>00798                 beat-&gt;<a class="code" href="struct__VisBeat.html#ac7cdecc4ba18df6f8fbf2d0a69369084">stickyConfidenceCount</a>++;
<a name="l00799"></a>00799                 <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#ac7cdecc4ba18df6f8fbf2d0a69369084">stickyConfidenceCount</a> &gt;= <a class="code" href="group__VisBeat.html#gaec59d1bf56dce0d4f557258d97bc517a">BEAT_MIN_STICKY</a>)
<a name="l00800"></a>00800                     beat-&gt;<a class="code" href="struct__VisBeat.html#a82886870bf5bc25dae5ef0b6e42c20a6">sticked</a>=1;
<a name="l00801"></a>00801             }
<a name="l00802"></a>00802             <span class="keywordflow">else</span>
<a name="l00803"></a>00803                 beat-&gt;<a class="code" href="struct__VisBeat.html#ac7cdecc4ba18df6f8fbf2d0a69369084">stickyConfidenceCount</a>=0;
<a name="l00804"></a>00804         }
<a name="l00805"></a>00805 
<a name="l00806"></a>00806         beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a> = <a class="code" href="lv__beat_8c.html#a31444d117345130ae44cf58cf75718c7">beat_get_bpm</a>(beat);
<a name="l00807"></a>00807 
<a name="l00808"></a>00808         <span class="comment">// Count how many beats we discriminated</span>
<a name="l00809"></a>00809         <span class="keywordflow">for</span> (i=0;i&lt;beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>;i++)
<a name="l00810"></a>00810             <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#a67d9ffc8276f55527d9dc2d36e4f6e1e">half_discriminated</a>[i]) hdCount++;
<a name="l00811"></a>00811 
<a name="l00812"></a>00812         <span class="keywordflow">if</span> (hdCount &gt;= beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>/2) <span class="comment">// If we removed at least half of our beats, then we are off course. We should double our bpm</span>
<a name="l00813"></a>00813         {
<a name="l00814"></a>00814             <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a> * 2 &lt; <a class="code" href="group__VisBeat.html#ga412e4b0f77e15ac1ba266f22282a122b">BEAT_MAX_BPM</a>) <span class="comment">// Lets do so only if the doubled bpm is &lt; BEAT_MAX_BPM</span>
<a name="l00815"></a>00815             {
<a name="l00816"></a>00816                 <a class="code" href="lv__beat_8c.html#a329ee39f88e8a43f970abc9157d088b9">beat_double_beat</a>(beat);
<a name="l00817"></a>00817                 memset(beat-&gt;<a class="code" href="struct__VisBeat.html#a67d9ffc8276f55527d9dc2d36e4f6e1e">half_discriminated</a>, 0, beat-&gt;<a class="code" href="struct__VisBeat.html#ab7a860c8cfc9b979c6d2ec7cd5a39a11">TCHistSize</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)); <span class="comment">// Reset discrimination table</span>
<a name="l00818"></a>00818             }
<a name="l00819"></a>00819         }
<a name="l00820"></a>00820         <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a> &gt; 500 || beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a> &lt; 0)
<a name="l00821"></a>00821         {
<a name="l00822"></a>00822             <a class="code" href="group__VisBeat.html#ga4a38754b9e1ee29e3c560636f4f4b816" title="Reset a VisBeat so that it may readapt.">visual_beat_reset_adapt</a>(beat);
<a name="l00823"></a>00823         }
<a name="l00824"></a>00824         <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a> &lt; <a class="code" href="group__VisBeat.html#ga9e1fcad8ef781c972001d3269511b670">BEAT_MIN_BPM</a>)
<a name="l00825"></a>00825         {
<a name="l00826"></a>00826             <span class="keywordflow">if</span> (++beat-&gt;<a class="code" href="struct__VisBeat.html#a28789b887916dc15129eac0a9f0b108a">doubleCount</a> &gt; 4) <span class="comment">// We&#39;re going too slow, lets double our bpm</span>
<a name="l00827"></a>00827                 <a class="code" href="lv__beat_8c.html#a329ee39f88e8a43f970abc9157d088b9">beat_double_beat</a>(beat);
<a name="l00828"></a>00828         }
<a name="l00829"></a>00829         <span class="keywordflow">else</span>
<a name="l00830"></a>00830             beat-&gt;<a class="code" href="struct__VisBeat.html#a28789b887916dc15129eac0a9f0b108a">doubleCount</a>=0;
<a name="l00831"></a>00831 
<a name="l00832"></a>00832         <span class="keywordflow">if</span> (beat-&gt;<a class="code" href="struct__VisBeat.html#a21ce4935417d045aa9043239c8f7217b">bpm</a> &gt; <a class="code" href="group__VisBeat.html#ga412e4b0f77e15ac1ba266f22282a122b">BEAT_MAX_BPM</a>) <span class="comment">// We&#39;re going too fast, lets slow our bpm by a factor of 2</span>
<a name="l00833"></a>00833         {
<a name="l00834"></a>00834             <span class="keywordflow">if</span> (++beat-&gt;<a class="code" href="struct__VisBeat.html#abf678935d2638bf5881650d846d14e39">halfCount</a> &gt; 4)
<a name="l00835"></a>00835                 <a class="code" href="lv__beat_8c.html#a909c7620df5bc4053636c33a54a266f1">beat_half_beat</a>(beat);
<a name="l00836"></a>00836         }
<a name="l00837"></a>00837         <span class="keywordflow">else</span>
<a name="l00838"></a>00838             beat-&gt;<a class="code" href="struct__VisBeat.html#abf678935d2638bf5881650d846d14e39">halfCount</a>=0;
<a name="l00839"></a>00839     }
<a name="l00840"></a>00840 }
<a name="l00841"></a>00841 
<a name="l00842"></a><a class="code" href="lv__beat_8c.html#a7abe8c605152e709d8099878908fe39a">00842</a> <span class="keywordtype">void</span> <a class="code" href="lv__beat_8c.html#a7abe8c605152e709d8099878908fe39a">beat_slider_step</a>(<a class="code" href="struct__VisBeat.html">VisBeat</a> *beat, <span class="keywordtype">int</span> Ctl, <span class="keywordtype">int</span> *slide)
<a name="l00843"></a>00843 {
<a name="l00844"></a>00844     <a class="code" href="lv__checks_8h.html#a2a00268a7d0b3c9329a1d85c3cca4e70" title="Return if expr is FALSE, showing a critical message with useful information.">visual_return_if_fail</a>(beat != <a class="code" href="lv__defines_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00845"></a>00845 
<a name="l00846"></a>00846     *slide += Ctl == <a class="code" href="group__VisBeat.html#gga621628139708973e25f132feb46e010da522c1268ac2295c8efca4e7896619f6d">VISUAL_BEAT_SLIDE_IN</a> ? beat-&gt;<a class="code" href="struct__VisBeat.html#a501f230e14669672ce22996a49b15362">inInc</a> : beat-&gt;<a class="code" href="struct__VisBeat.html#a23d65d540f200b468799577b309d4603">outInc</a>;
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     <span class="keywordflow">if</span> (!*slide || *slide == 8) {
<a name="l00849"></a>00849         <span class="keywordflow">if</span>(Ctl == <a class="code" href="group__VisBeat.html#gga621628139708973e25f132feb46e010da522c1268ac2295c8efca4e7896619f6d">VISUAL_BEAT_SLIDE_IN</a>) {
<a name="l00850"></a>00850             beat-&gt;<a class="code" href="struct__VisBeat.html#a501f230e14669672ce22996a49b15362">inInc</a> *= -1;
<a name="l00851"></a>00851         } <span class="keywordflow">else</span> {
<a name="l00852"></a>00852             beat-&gt;<a class="code" href="struct__VisBeat.html#a23d65d540f200b468799577b309d4603">outInc</a> *= -1;
<a name="l00853"></a>00853         }
<a name="l00854"></a>00854     }
<a name="l00855"></a>00855 }
<a name="l00856"></a>00856 
</pre></div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Mon Apr 9 2012 22:25:08 for libvisual by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
